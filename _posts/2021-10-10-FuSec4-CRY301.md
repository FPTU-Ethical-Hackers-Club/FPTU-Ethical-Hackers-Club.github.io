---
title: FPTU SecAthon 2021 | Cryptographic Writeup | CRY301
author:
  name: fairytypean
  link: https://github.com/thangpd3160
date: 2021-10-10 10:00:00 +0700
categories: [CTF, Cryptographic Challenges]
tags: [writeups, cryptographic, fusec21]
mermaid: true
math: true
---

# CRY301

## Source code and analysis 

Má»™t bÃ i crypto giáº£i báº±ng kiáº¿n thá»©c toÃ¡n há»c vÃ  tÆ° duy vá» code. Full source code Ä‘á» bÃ i xem táº¡i [Ä‘Ã¢y](https://github.com/thangpd3160/FUSEC-2021/blob/main/CRY301/server.py)

BÃ i nÃ y yÃªu cáº§u mÃ¬nh tÃ¬m Ä‘Æ°á»£c sá»‘ `x` ban Ä‘áº§u tá»« káº¿t quáº£ cá»§a 2 hÃ m `easyone(x)` vÃ  `alittlebitharderone(x)`.

## PhÃ¢n tÃ­ch hÃ m `easyone(x)`

NhÃ¬n sÆ¡ qua hÃ m `easyone(x)`, cÃ³ 3 phÃ©p biáº¿n Ä‘á»•i chÃ­nh Ä‘Æ°á»£c láº·p Ä‘i láº·p láº¡i 3 láº§n:

- PhÃ©p `xor` vá»›i left shift bit cá»§a chÃ­nh nÃ³

- PhÃ©p nhÃ¢n

- PhÃ©p `&` vá»›i `0xffffffffffffffffffffffffffffffff`.

```python
def easyone(x):
    assert(x < 2 ** 128)
    x ^= x >> (64 + 19)
    x *= 0xd3856e824d9c8a26aef65c0fe1cc96db #281159923981539500379670095774511568603
    x &= 0xffffffffffffffffffffffffffffffff
    x ^= x >> (64 + 3)
    x *= 0xe44035c8f8387dc11dd3dd67097007cb #303397380928069120521467215513016862667
    x &= 0xffffffffffffffffffffffffffffffff
    x ^= x >> (64 + 20)
    x *= 0xc9f54782b4f17cb68ecf11d7b378e445 #268448390289851351177030176676964262981
    x &= 0xffffffffffffffffffffffffffffffff
    x ^= x >> (64 + 2)
    return x
```

NhÆ° váº­y, cÃ³ 2 bÃ i toÃ¡n Ä‘áº·t ra cáº§n giáº£i quyáº¿t:

- TÃ¬m `x` biáº¿t `a * x = b (mod n)` vá»›i `a`, `b`, `n` Ä‘Ã£ cho trÆ°á»›c

- KhÃ´i phá»¥c láº¡i káº¿t quáº£ phÃ©p xor. TÃ¬m `x` cÃ³ $a \oplus x = b$ vá»›i `a`, `b` Ä‘Ã£ biáº¿t, khÃ¡ Ä‘Æ¡n giáº£n vá»›i $x = a \oplus b$.

CÃ¹ng Ä‘i sÃ¢u hÆ¡n chÃºt vÃ o tá»«ng bÃ i toÃ¡n 1 nhÃ©

### BÃ i toÃ¡n Ä‘áº§u tiÃªn

ÄÃ¢y lÃ  bÃ i toÃ¡n cÆ¡ báº£n cÆ¡ báº£n vá» inverse mod (modular inverse) trong finite field (trÆ°á»ng há»¯u háº¡n). ÄÆ¡n giáº£n, mÃ¬nh cÃ³ thá»ƒ tÃ¬m $x$ báº±ng cÃ¡ch $x = a^{-1} * b$ $(mod$ $n)$, trong Ä‘Ã³, $a^{-1} * b$ $(mod$ $n)$ lÃ  giÃ¡ trá»‹ inverse modulo cá»§a a trong finite field $(mod$ $n)$

Chi tiáº¿t cÃ¡ch tÃ¬m inverse mod báº±ng toÃ¡n há»c vá»›i extended euclidean algorithm cÃ³ thá»ƒ xem táº¡i [Ä‘Ã¢y](https://www.youtube.com/watch?v=fq6SXByItUI). LÃºc code giáº£i thÃ¬ mÃ¬nh dÃ¹ng luÃ´n hÃ m `invert(a, n)` trong thÆ° viá»‡n `gmpy2` cá»§a python Ä‘á»ƒ tÃ¬m $a^{-1} * b$ $(mod$ $n)$.

MÃ¬nh chuyá»ƒn 1 Ä‘oáº¡n code sang dáº¡ng bÃ i toÃ¡n gá»‘c Ä‘á»ƒ dá»… hÃ¬nh dung. Cá»¥ thá»ƒ, Ä‘oáº¡n code dÆ°á»›i Ä‘Ã¢y biá»ƒu diá»…n dÆ°á»›i dáº¡ng toÃ¡n há»c sáº½ lÃ  $x * 281159923981539500379670095774511568603 = b$ $(mod$ $n)$ vá»›i `b` cÃ³ thá»ƒ thu Ä‘Æ°á»£c tá»« viá»‡c dá»‹ch láº¡i phÃ©p `xor` (bÃ i toÃ¡n 2).

> LÆ°u Ã½: `x &= 0xffffffffffffffffffffffffffffffff <=> x %= 0xffffffffffffffffffffffffffffffff` hay `x %= 2**128` 

```python
x *= 0xd3856e824d9c8a26aef65c0fe1cc96db #281159923981539500379670095774511568603
x &= 0xffffffffffffffffffffffffffffffff
```

NhÆ° váº­y, ta cÃ³ thá»ƒ dá»… dÃ ng tÃ¬m `x` vá»›i $x = b$ $âˆ—$ $281159923981539500379670095774511568603^{âˆ’1}$ $(mod$ $2^{128})$

```python
x *= gmpy2.invert(268448390289851351177030176676964262981, 2**128)
x &= 0xffffffffffffffffffffffffffffffff
```

Váº¥n Ä‘á» lÃ  Ä‘á»ƒ hoÃ n thiá»‡n quÃ¡ trÃ¬nh giáº£i thÃ¬ mÃ¬nh cáº§n tÃ¬m `b`, nghÄ©a lÃ  cáº§n pháº£i giáº£i quyáº¿t bÃ i toÃ¡n sá»‘ 2.

### BÃ i toÃ¡n thá»© 2

Äá»ƒ giáº£i quyáº¿t pháº§n `xor` nÃ y, chÃºng ta cáº§n pháº£i lÆ°u tÃ¢m `x` sau khi bitshift thÃ¬ cÃ²n nhá»¯ng bit nÃ o cÃ²n giá»¯ nguyÃªn, bit nÃ o dá»‹ch chuyá»ƒn Ä‘á»ƒ thá»±c hiá»‡n `xor`.

```python
x ^= x >> (64 + 2)
```

Äá»ƒ dá»… hÃ¬nh dung, báº¡n cÃ³ thá»ƒ nhÃ¬n hÃ¬nh mÃ´ phá»ng trÆ°á»›c vÃ  sau khi leftshift dÆ°á»›i Ä‘Ã¢y. Bit mÃ u xanh lÃ  nhá»¯ng bit cÃ²n giá»¯ nguyÃªn sau khi leftshift. Bit mÃ u vÃ ng lÃ  bit mÃ u xanh Ä‘Æ°á»£c chuyá»ƒn ra sau khi leftshift. Bit mÃ u Ä‘á» lÃ  nhá»¯ng bit cÃ³ thá»ƒ bá»‹ thay Ä‘á»•i sau bitshift (vÃ  cÅ©ng lÃ  bit thá»±c sá»± tham gia `xor`)

![1](https://images.viblo.asia/6ade6ce4-5714-4116-8dcf-a0033e31384d.png)

Dá»… dÃ ng nháº­n tháº¥y, pháº§n bit dÃ¹ng Ä‘á»ƒ xor vá»›i giÃ¡ trá»‹ x ban Ä‘áº§u váº«n *giá»¯ nguyÃªn* sau khi `xor` $\longrightarrow$. NhÆ° váº­y mÃ¬nh cÃ³ thá»ƒ dá»… dÃ ng khÃ´i phá»¥c pháº§n bit dÃ¹ng Ä‘á»ƒ `xor` báº±ng cÃ¡ch *leftshift láº¡i giÃ¡ trá»‹ sau khi xor báº±ng Ä‘Ãºng má»™t khoáº£ng dÃ¹ng Ä‘á»ƒ xor trÆ°á»›c Ä‘Ã³* (tá»©c `leftshift (64 + 2)` Ä‘Æ¡n vá»‹ trong trÆ°á»ng há»£p trÃªn).

Káº¿t luáº­n trÃªn Ä‘Ãºng vá»›i táº¥t cáº£ trÆ°á»ng mÃ  `x` Ä‘Æ°á»£c leftshift Ã­t nháº¥t 64 Ä‘Æ¡n vá»‹.

Váº­y lÃ  mÃ¬nh Ä‘Ã£ giáº£i quyáº¿t xong cáº£ 2 bÃ i toÃ¡n trÃªn! Cuá»‘i cÃ¹ng mÃ¬nh cÃ³ Ä‘oáº¡n code Ä‘á»ƒ láº¥y giÃ¡ trá»‹ `x` tá»« hÃ m `easyone(x)` nhÆ° sau:

```python
def solveeasyone(x):
    x ^= x >> (64 + 2)
    x *= gmpy2.invert(268448390289851351177030176676964262981, 2**128)
    x &= 0xffffffffffffffffffffffffffffffff
    x ^= x >> (64 + 20)
    x *= gmpy2.invert(303397380928069120521467215513016862667, 2**128)
    x &= 0xffffffffffffffffffffffffffffffff
    x ^= x >> (64 + 3)
    x *= gmpy2.invert(281159923981539500379670095774511568603, 2**128)
    x &= 0xffffffffffffffffffffffffffffffff
    x ^= x >> (64 + 19)
    return int(x)
```

Tada, first round~~ 

![2](https://images.viblo.asia/2db1bbfe-b210-4a94-9758-dac7962e879c.png)

## PhÃ¢n tÃ­ch hÃ m `alittlebitharderone(x)`

Giáº£i quyáº¿t hÃ m nÃ y cÅ©ng cáº§n giáº£i quyáº¿t 2 bÃ i toÃ¡n nhÆ° hÃ m `easyone(x)`. BÃ i toÃ¡n 1 vá» tÃ¬m inverse mod hoÃ n toÃ n giá»‘ng há»‡t. CÃ¡i khÃ³ hÆ¡n náº±m á»Ÿ BÃ i toÃ¡n 2, do mÃ¬nh khÃ´ng thá»ƒ ngay láº­p tá»©c khÃ´i phá»¥ Ä‘Æ°á»£c bit dÃ¹ng trong phÃ©p `xor` trÆ°á»›c Ä‘Ã³ tá»« káº¿t quáº£ thu Ä‘Æ°á»£c.

Tuy nhiÃªn, Ä‘iá»u Ä‘Ã¡ng má»«ng lÃ  nguyÃªn lÃ½ cÃ¡ch lÃ m váº«n tháº¿. ChÃºng ta cÅ©ng sáº½ dÃ¹ng nhá»¯ng bit cÃ²n nguyÃªn, Ä‘á»ƒ khÃ´i phá»¥c láº¡i nhá»¯ng bit gá»‘c, rá»“i lÃ¢n la dáº§n dáº§n Ä‘á»ƒ khÃ´i phá»¥c toÃ n bá»™ bit gá»‘c Ä‘Ã³. MÃ¬nh mÃ´ phá»ng vá»›i 1 bÃ i toÃ¡n nhá» vá»›i 1 chuá»—i 6 bit vá»›i Ä‘á»™ leftshift báº±ng 2 nhÆ° sau:

![3](https://images.viblo.asia/15156dc0-6a32-4833-9b3f-8de565499e2a.png)

Vá»›i trÆ°á»ng há»£p nhÆ° trÃªn, mÃ¬nh khÃ´i phá»¥c láº¡i giÃ¡ trá»‹ ban Ä‘áº§u cá»§a `x` báº±ng cÃ¡ch Ä‘i qua tá»«ng bÆ°á»›c nhÆ° sau Ä‘Ã¢y (MÃ´ táº£ báº±ng hÃ¬nh áº£nh cho dá»… hiá»ƒu nhÃ©)

- `Xor` 2 bit Ä‘áº§u (2 bit cÃ²n giá»¯ nguyÃªn sau khi `xor`) vá»›i 2 bit liá»n ká»u sau nÃ³. Nhá»¯ng bit cÃ²n láº¡i giá»¯ nguyÃªn. NhÆ° váº­y, mÃ¬nh Ä‘Ã£ khÃ´i phá»¥c láº¡i Ä‘Æ°á»£c bit sá»‘ 3 vÃ  bit sá»‘ 2:

    ![4](https://images.viblo.asia/c4e889d6-91fc-4bdd-ba28-bd35b628b7e3.png)

- `Xor` tiáº¿p 2 bit vá»«a thu Ä‘Æ°á»£c (bit sá»‘ 3 vÃ  2) vá»›i 2 bit liá»n ká» sau nÃ³ Ä‘á»ƒ khÃ´i phá»¥c tiáº¿p 2 bit cÃ²n láº¡i (bit 5 vÃ  6) :
    ![5](https://images.viblo.asia/42916e48-cf34-4a14-bc3b-c70869387a78.png)

Váº­y lÃ m mÃ¬nh Ä‘Ã£ thu láº¡i Ä‘Æ°á»£c Ä‘oáº¡n bit gá»‘c, tá»©c giÃ¡ trá»‹ cá»§a `x` cáº§n tÃ¬m. Vá»›i chuá»—i bit dÃ i hÆ¡n, mÃ¬nh chá»‰ cáº§n cháº¡y quÃ¡ trÃ¬nh trÃªn láº·p Ä‘i láº·p láº¡i lÃ  Ä‘Æ°á»£c.

Dá»… rá»“i pháº£i khÃ´ng? Máº·c dÃ¹ mÃ¬nh nghÄ© ra Ä‘Æ°á»£c Ã½ tÆ°á»Ÿng mÃ¬nh viá»‡c code tá»‘n cá»§a mÃ¬nh táº­n 30 phÃºt... vÃ  cuá»‘i cÃ¹ng láº¡i chá»‰ thÃ nh 1 Ä‘oáº¡n code ngáº¯n ngá»§i sau:

```python
def xor(a, b):
    return ''.join(str(int(_a) ^ int(_b)) for _a, _b in zip(a, b))

def shiftsolong(x, bitshift):
    x = '{0:b}'.format(x)
    for i in range(0, len(x) - bitshift):
        x = x[:bitshift*(i+1)] + xor(x[bitshift*i:bitshift*(i+1)], x[bitshift*(i+1):bitshift*(i+2)]) + x[bitshift*(i+2):]
    return int(x, 2)
```

Ta nÃ³i Ä‘á»i vá» cÄƒn báº£n lÃ  buá»“n mÃ  ğŸ˜¢ ThÃ´i tá»•ng há»£p láº¡i, thÃ¬ mÃ¬nh cÃ³ Ä‘oáº¡n code láº¥y láº¡i giÃ¡ trá»‹ `x` tá»« hÃ m `alittlebitharderone(x)`:

```python
def solvehardone(x):
    x = shiftsolong(x, 2)
    x *= gmpy2.invert(268448390289851351177030176676964262981, 2**128)
    x &= 0xffffffffffffffffffffffffffffffff
    x = shiftsolong(x, 20)
    x *= gmpy2.invert(303397380928069120521467215513016862667, 2**128)
    x &= 0xffffffffffffffffffffffffffffffff
    x = shiftsolong(x, 3)
    x *= gmpy2.invert(281159923981539500379670095774511568603, 2**128)
    x &= 0xffffffffffffffffffffffffffffffff
    x = shiftsolong(x, 19)
    return int(x)
```

Qua vÃ²ng 2 vÃ  nháº­n Ä‘Æ°á»£c flag. Chá»‰ lÃ  khÃ´ng ká»‹p submit ná»¯a... 

![6](https://images.viblo.asia/dcae7e07-d742-4c9c-a62d-19b14cb0e491.png)

Náº¿u cÃ³ Æ°á»›c muá»‘n trong cuá»™c Ä‘á»i nÃ y, mÃ¬nh sáº½ Æ°á»›c cÃ³ má»™t khÃ´ng gian riÃªng mÃ  thá»i gian cháº£y cháº­m Ä‘á»ƒ ngá»“i debug trÆ°á»›c khi háº¿t giá» FUSEC ğŸ˜‡