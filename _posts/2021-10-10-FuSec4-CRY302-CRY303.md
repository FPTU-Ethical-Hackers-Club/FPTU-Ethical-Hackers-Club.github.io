---
title: FPTU SecAthon 2021 | Cryptographic Writeup | CRY302 & CRY303
author:
  name: fairytypean
  link: https://github.com/thangpd3160
date: 2021-10-10 11:00:00 +0700
categories: [CTF, Cryptographic Challenges]
tags: [writeups, cryptographic, fusec21]
mermaid: true
---

# CRY302

M·ªôt b√†i li√™n quan t·ªõi hash, c√°ch th·ª±c hi·ªán kh√° d·ªÖ. Full source code b·∫°n c√≥ th·ªÉ xem t·∫°i [ƒë√¢y](https://github.com/thangpd3160/FUSEC-2021/blob/main/CRY302/server.py)

![1](https://images.viblo.asia/82e681c0-6022-4524-80ac-2da6498a8ac9.png)

## B·ªï ƒë·ªÅ

T√≥m t·∫Øt l·∫°i th√¨ m√¨nh s·∫Ω ƒë∆∞·ª£c ƒë∆∞a cho 1 s·ªë ti·ªÅn ng·∫´u nhi√™n t·ª´ 1 t·ªõi 2000 v√† b·ªã b·∫Øt ph·∫£i mua 1 c√°i FLAG c√≥ gi√° t·∫≠n 99,999. Ki·ªÉu g√¨ c≈©ng kh√¥ng ƒë·ªß cho ƒë∆∞·ª£c.

Khi m√¨nh order 1 v·∫≠t ph·∫©m b·∫•t k·ª≥, `order` c·ªßa m√¨nh s·∫Ω c√≥ c·∫•u tr√∫c d·∫°ng ki·ªÉu `product=FLAG&price=99999&time=1633845957.70&sign=67df43a8c83ea4ee53ac7bb61cc9a51661f5b55b54153afb942246c11a3ab9a93cb7a1cecb235195eab957fceb3e3daaf3e97f484d29718aea8b0f63e1a3704a` (ƒë√£ ƒë∆∞·ª£c decode t·ª´ chu·ªói base64 encoded).

Khi nh·∫≠p l·∫°i c√°i `order` ·ªü tr√™n ƒë·ªÉ x√°c nh·∫≠n mua s·∫£n ph·∫©m, `order` n√†y ƒë∆∞·ª£c ki·ªÉm tra c√°c c·∫•u tr√∫c v√† t√≠nh to√†n v·∫πn, c·ª• th·ªÉ g·ªìm:

- T·ªìn t·∫°i c·∫∑p parameter-value `sign={sign_value}`

- C√≥ signature h·ª£p l·ªá `sha512(signkey+payment).hexdigest() == signature`

Sau khi qua c√°c b√†i check tr√™n, `payment` s·∫Ω ƒë∆∞·ª£c truy·ªÅn v√†o h√†m `parse_sql(self, query)` ƒë·ªÉ ti·∫øn h√†nh extract c√°c parameter t∆∞∆°ng ·ª©ng.

```python
def parse_qsl(self, query):
    m = {}
    parts = query.split(b'&')
    for part in parts:
        key, val = part.split(b'=')
        m[key] = val
    return m
```

V·ªõi c√°ch h√†m parse ho·∫°t ƒë·ªông nh∆∞ n√†y, gi·∫£ s·ª≠ query c√≥ 2 c·∫∑p gi√° tr·ªã c·ªßa `price` (v√≠ d·ª• nh∆∞ `price=99999&price=0`) th√¨ gi√° tr·ªã `price` cu·ªëi c√πng s·∫Ω ƒë∆∞·ª£c quy·∫øt ƒë·ªãnh b·ªüi c√°i ƒë·∫±ng sau. ƒêi·ªÅu ƒë√≥ ƒë·ªìng nghƒ©a v·ªõi vi·ªác n·∫øu m√¨nh c√≥ th·ªÉ k√©o d√†i c√°i `payment` c·ªßa m√¨nh b·∫±ng c√°ch append th√™m 1 ƒëo·∫°n `&price=0`, m√¨nh c√≥ th·ªÉ mua b·∫•t c·ª© th·ª© g√¨ trong c·ª≠a h√†ng!

√ù t∆∞·ªüng k√©o d√†i 1 ƒëo·∫°n payment ƒë∆∞·ª£c hash ƒë√£ ƒë∆∞a m√¨nh ƒë·∫øn *hash length extension attack*

## Hash length extension attack

### Hash length extension attack l√† g√¨?

Hash length extension attack cho ph√©p m√¨nh *k√©o d√†i chu·ªói vƒÉn b·∫£n ƒë∆∞·ª£c hash*, ƒë·ªìng th·ªùi t√≠nh to√°n *gi√° tr·ªã hash m·ªõi h·ª£p l·ªá* cho chu·ªói vƒÉn b·∫£n ƒë∆∞·ª£c k√©o d√†i ra t·ª´ hash c·ªßa chu·ªói vƒÉn b·∫£n ban ƒë·∫ßu.

### Ngu·ªìn ƒë·ªçc hi·ªÉu hash length extension attack

Tr∆∞·ªõc h·∫øt, c·∫ßn ph·∫£i hi·ªÉu ƒë∆∞·ª£c sha512 ho·∫°t ƒë·ªông nh∆∞ th·∫ø n√†o ƒë√£. B·∫°n c√≥ th·ªÉ xem t·ªïng quan v·ªÅ h√†m sha512 t·∫°i [ƒë√¢y](http://https//medium.com/@zaid960928/cryptography-explaining-sha-512-ad896365a0c1) v√† xem chi ti·∫øt c√°ch sha512 v·∫≠n h√†nh t·ª´ng b∆∞·ªõc 1 t·∫°i [ƒë√¢y](https://www.youtube.com/watch?v=JViXozmJnSk). Thanks for Indian guys ‚ù§Ô∏è

Ti·∫øp ƒë√≥, m√¨nh ƒë·ªçc m√¥ t·∫£ c√°ch hash length extension attack ho·∫°t ƒë·ªông, v√† c√≥ b·∫£n demo t·∫°i [ƒë√¢y](https://blog.skullsecurity.org/2012/everything-you-need-to-know-about-hash-length-extension-attacks). Th·ª±c ra tr∆∞·ªõc c√≥ 1 b√†i blog b·∫±ng ti·∫øng Vi·ªát cho h·ªç hash SHA lu√¥n, m√† gi·ªù trang ƒë·∫•y s·∫≠p r·ªìi üò¢ N√™n m√¨nh s·∫Ω m√¥ t·∫£ l·∫°i trong b√†i n√†y ƒë·ªÉ c√°c b·∫°n hi·ªÉu d∆∞·ªõi g√≥c ƒë·ªô python code, ph√≤ng tr∆∞·ªùng h·ª£p c√°c b·∫°n ƒë·ªçc demo tr√™n m·∫°ng ƒë·ªÅu code b·∫±ng C v√† kh√¥ng hi·ªÉu g√¨ =)))

### ƒêi·ªÅu ki·ªán ƒë·ªÉ th·ª±c hi·ªán hash length extension attack

ƒê·ªÉ th·ª±c hi·ªán ƒë∆∞·ª£c hash length extension attack m√† vƒÉn b·∫£n x√°c th·ª±c c√≥ d·∫°ng `secret_value + public_value`, m√¨nh c·∫ßn c√≥ ƒë·ªß 3 d·ªØ ki·ªán:

- ƒê·ªô d√†i c·ªßa `secret_value`, ·ªü trong b√†i n√†y ch√≠nh l√† ƒë·ªô d√†i c·ªßa `signkey`. B√†i kh√¥ng cho c·ª• th·ªÉ nh∆∞ng ch·ªâ cho 24 gi√° tr·ªã kh·∫£ nƒÉng, ho√†n to√†n c√≥ th·ªÉ bruteforce. M√¨nh *kh√¥ng c·∫ßn* gi√° tr·ªã c·ªßa `secret_value`!

- Gi√° tr·ªã c·ªßa `public_value`, ·ªü trong b√†i n√†y ch√≠nh l√† `payment`

- Gi√° tr·ªã hash c·ªßa `secret_value + public_value`, ·ªü trong b√†i n√†y ch√≠nh l√† `sign`

V·∫≠y l√† b√†i n√†y h·ªôi t·ª• ƒë·ªß c·∫£ 3 y·∫øu t·ªë ƒë·ªÉ ti·∫øn h√†nh r·ªìi.

## Ti·∫øn h√†nh t·∫•n c√¥ng th√¥i!

M·ª•c ti√™u c·ªßa m√¨nh bao g·ªìm:

- Append th√™m 1 ƒëo·∫°n `&price=0` v√†o cu·ªëi `payment`

- T·∫°o ra 1 gi√° tr·ªã `sign` m·ªõi sao cho `sha512(signkey+payment) = sign` v·ªõi `payment` m·ªõi

S∆° s∆° c∆° ch·∫ø ho·∫°t ƒë·ªông c·ªßa hash length extension attack s·∫Ω nh∆∞ sau:

- __C∆° ch·∫ø ho·∫°t ƒë·ªông c·ªßa h√†m hash:__ H√†m hash sha512 s·∫Ω chia input ƒë·∫ßu v√†o th√†nh c√°c kh·ªëi 1024 bits, m·ªói kh·ªëi l·∫°i chia th√†nh t·ª´ng ph·∫ßn nh·ªè `h[i]` g·ªìm 128 bits. M·ªôt tuple `(h[0], h[1], h[2], h[3], h[4], h[5], h[6], h[7])` ƒë∆∞·ª£c g·ªçi l√† `current_state` c·ªßa h√†m hash hi·ªán t·∫°i. `current_state` s·∫Ω ƒë∆∞·ª£c d√πng ƒë·ªÉ t√≠nh state cho kh·ªëi 1024 bits ti·∫øp theo. H√†m x·ª≠ l√Ω qu√° tr√¨nh n√†y g·ªçi l√† `round_function` ho·∫∑c `compress` (t√πy theo t√†i li·ªáu). K·∫øt qu·∫£ cho kh·ªëi 1024 bits cu·ªëi c√πng ch√≠nh l√† gi√° tr·ªã hash m√¨nh thu ƒë∆∞·ª£c.

- __C∆° ch·∫ø ho·∫°t ƒë·ªông c·ªßa hash length extension attack:__ T·ª´ c∆° ch·∫ø ho·∫°t ƒë·ªông tr√™n c·ªßa h√†m hash, m√¨nh c√≥ th·ªÉ th·∫•y r·∫±ng ch·ªâ c·∫ßn bi·∫øt ƒë∆∞·ª£c `current_state` v√† kh·ªëi 1024 bits cu·ªëi c√πng, m√¨nh ho√†n to√†n c√≥ th·ªÉ t√≠nh to√°n `state` cho kh·ªëi 1024 bits ti·∫øp theo, trong ƒë√≥, kh·ªëi 1024 bits s·∫Ω c√≥ gi√° tr·ªã t√πy √Ω m√¨nh th√≠ch. ƒê√≥ c≈©ng ch√≠nh l√† gi√° tr·ªã hash m·ªõi v·ªõi chu·ªói vƒÉn b·∫£n ƒë∆∞·ª£c k√©o d√†i.

Kh√° l√† ƒë∆°n gi·∫£n ph·∫£i kh√¥ng. Gi·ªù m√¨nh s·∫Ω ƒëi v√†o c·ª• th·ªÉ nh√©:

1. Order FLAG, nh·∫≠n gi√° tr·ªã `order` tr·∫£ v·ªÅ `product=FLAG&price=99999&time=1633849486.36&sign=275e626950c677c05a669e4e9d73f015858ca2b477335b2e99f419f9f0bc860736e95bd87de1226764c70f8c59029edc10e6b2a514342bb85f0c29fe24b9d3e2`. T√°ch `payment` v√† `sign` ri√™ng.

2. Padding cho `payment` ƒë·ªÉ `payment` c√≥ d·∫°ng `k ‚àó 1024`, v√† l·∫•y block cu·ªëi c√πng, thu ƒë∆∞·ª£c `product=FLAG&price=99999&time=1633849486.36\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02P`. V·ªën chu·ªói ban ƒë·∫ßu kh√¥ng d√†i h∆°n 1024 bits n√™n c≈©ng ch·ªâ c√≥ block duy nh·∫•t. Trong ph·∫ßn v√≠ d·ª• n√†y, m√¨nh gi·∫£ s·ª≠ ƒë·ªô d√†i c·ªßa `signkey` b·∫±ng 31. C∆° ch·∫ø padding m√¨nh ƒë√≠nh k√®m ngu·ªìn ·ªü tr√™n.

3. Append chu·ªói `&price=0` v√†o chu·ªói ƒë√£ ƒë∆∞·ª£c padding ·ªü tr√™n. L·∫°i t·∫°o 1 kh·ªëi 1024 bits c√≥ ch·ª©a `&price=0` b·∫±ng c√°ch padding, thu ƒë∆∞·ª£c `&price=0\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x018`

4. Extract `state` t·ª´ gi√° tr·ªã `sign`, sau ƒë√≥ ƒë∆∞a `state` c√πng kh·ªëi 1024 bits c√≥ ch·ª©a `&price=0` ·ªü tr√™n v√†o h√†m `compress` c·ªßa sha512, thu ƒë∆∞·ª£c gi√° tr·ªã   m·ªõi b·∫±ng `ad38b9ceecbdf41de6bb33970a473ecc1c500935e2cfd90007be639fa6754b6272c45340fca0f173090748722cc1e25e3440cc9975c3b712a8cabe7809cf6d7f`

5. N·ªëi chu·ªói `payment` m·ªõi v√† `sign` m·ªõi v√†o v·ªõi nhau, chuy·ªÉn l√™n server v√† l·∫•y flag. order m·ªõi s·∫Ω l√† `product=FLAG&price=99999&time=1633849486.36\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02P&price=0`

V·∫≠y l√† xong!

## Full code exploit

V√¨ b√†i kh√¥ng cho gi√° tr·ªã c·ª• th·ªÉ c·ªßa ƒë·ªô d√†i `signkey`, n√™n m√¨nh ph·∫£i vi·∫øt 1 ƒëo·∫°n code ch·∫°y t·ª± ƒë·ªông trong kho·∫£ng gi√° tr·ªã `[8, 32]`. Full code exploit c√≥ th·ªÉ xem ·ªü [ƒë√¢y](http://https//github.com/thangpd3160/FUSEC-2021/blob/main/CRY302/solve.py). Trong code n√†y, m√¨nh c√≥ s·ª≠ d·ª•ng l·∫°i th∆∞ vi·ªán [hlextend](https://github.com/stephenbradshaw/hlextend/blob/master/hlextend.py) c·ªßa *stephenbradshaw* tr√™n github, v·ªõi m·ªôt ch√∫t ch·ªânh s·ª≠a ƒë·ªÉ output ra c√≥ d·∫°ng byte thay v√¨ string.

```python
def solve():
    [REDACTED]

    #order
    output = recvuntil(clientSock, b'Your choice:')
    clientSock.sendall(b'2\n')
    output = recvuntil(clientSock, b'ID:')
    clientSock.sendall(b'6\n')
    output = recvuntil(clientSock, b'Your choice:')
    order = output.split(b'\n')[0][len('Your order:'):].strip()
    order = b64decode(order).decode('latin-1')

    sp = order.rfind('&sign=')
    sign = order[sp+6:]
    payment = order[:sp]
    append_msg = '&price=0'
    

    for i in range(8, 33):
        sha = hlextend.new('sha512')
        new_payment = sha.extend(append_msg, payment, i, sign)
        new_sign = sha.hexdigest()
        new_order = new_payment + b'&sign=' + new_sign.encode()
        new_order = b64encode(new_order)

        #confirm order
        clientSock.sendall(b'3\n')
        output = recvuntil(clientSock, b'Your order:')
        clientSock.sendall(new_order + b'\n')
        output = recvuntil(clientSock, b'Your choice:')
        if b'FUSec{' in output:
            flag = output.decode()[output.index(b'FUSec{'):output.index(b'}')+1]
            print(flag)
            break
```

Flag `FUSec{th1s_1s_4n_0ld_vul_bUt...}`

# CRY303

M·ªôt b√†i si√™u kh√≥ v·ªÅ __Knapsack cipher__ s·ª≠ d·ª•ng LLL (Lenstra‚ÄìLenstra‚ÄìLov√°sz), hay c√≤n g·ªçi l√† __Latice Reducation Technique__, ƒë·ªÉ gi·∫£i.

N√≥i th·∫≠t th√¨ b√†i n√†y m√¨nh c≈©ng kh√¥ng t·ª± l√†m ƒë∆∞·ª£c l√∫c tham gia gi·∫£i CTF, nh∆∞ng search google ƒë∆∞·ª£c 1 b√†i gi·ªëng t·ªõi 90%, n√™n ch·ªâ ƒë·ªçc hi·ªÉu code r·ªìi gi·∫£i l·∫°i. B·ªüi v√¨ b√†i c≈©ng kh√¥ng c√≥ g√¨ kh√°c bi·ªát m·∫•y, n√™n m√¨nh ƒë·ªÉ ngu·ªìn b√†i g·ªëc ·ªü ƒë√¢y ƒë·ªÉ c√°c b·∫°n ƒë·ªçc v·∫≠y.

- [Link github exploit code + writeup](https://github.com/pcw109550/write-up/tree/master/2020/KAPO/Baby_Bubmi)
    
- [B√†i vi·∫øt c·ª• th·ªÉ gi·∫£i th√≠ch c∆° ch·∫ø ho·∫°t ƒë·ªông](http://www.secmem.org/blog/2020/09/20/poka-science-war-hacking/)

ƒê·ªÅ b√†i n√†y v√† code gi·∫£i (ƒë√£ s·ª≠a theo b√†i) m√¨nh ƒë·ªÉ ·ªü [github](https://github.com/thangpd3160/FUSEC-2021/tree/main/CRY303) c·ªßa m√¨nh.

> Th·∫ø l√† h·∫øt crypto r·ªìi. N·∫øu m√† k·ªãp gi·∫£i h·∫øt th√¨ m√¨nh c≈©ng m·∫°nh d·∫°n insert bomman meme g√°y... nh∆∞ng kh√¥ng ƒë∆∞·ª£c n√™n g√† kh√¥ng g√°y n·ªØa...
